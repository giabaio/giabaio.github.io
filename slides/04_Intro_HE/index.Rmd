---
title: "&#8291;4. Introduction to health economic evaluation"
author: Gianluca Baio
institute: "[Department of Statistical Science](https://www.ucl.ac.uk/statistics/) | University College London"
params: 
   - conference: "STAT0019 - Bayesian Methods in Health Economics"
   - location: "UCL"
date: 
output:
  xaringan::moon_reader:
    includes: 
       in_header: "../assets/latex_macros.html" 
       ## This line adds a logo based on the format selected in the file 'assets/THEME/include_logo.html'
       ## NB: the actual options (eg placement of the logo and actual logo file) can be changed there
       ## There's also a script to manipulate the colouring scheme for the UCL logo (from a basic black/white one)
       after_body: "../assets/ucl-stats/insert-logo.html"
    seal: false
    yolo: no
    lib_dir: libs
    nature:
      beforeInit: ["https://platform.twitter.com/widgets.js"]
      highlightStyle: github
      highlightLines: yes
      countIncrementalSlides: no
      ratio: '16:9'
      titleSlideClass:
      - center
      - middle
    self_contained: false 
    css:
    - "../assets/ucl-stats.css"
---

```{r echo=F,message=FALSE,warning=FALSE,comment=NA}
# Sources the R file with all the relevant setup and commands
source("../assets/setup.R")

# Stuff from 'xaringanExtra' (https://pkg.garrickadenbuie.com/xaringanExtra)
# This allows the use of panels (from 'xaringanExtra')
xaringanExtra::use_panelset()
# This allows to copy code from the slides directly
xaringanExtra::use_clipboard()
# This freezes the frame for when there's a gif included
xaringanExtra::use_freezeframe()

# Defines the path to the file with the .bib entries (in case there are references)
bibfile=ReadBib("~/Dropbox/Perso/Office/CV/mypubs.bib",check = FALSE)
```

class: title-slide

# `r rmarkdown::metadata$title`

## `r rmarkdown::metadata$author`

### `r rmarkdown::metadata$institute`    

.title-small[
`r icons::icon_style(icons::fontawesome("envelope",style = "solid"),scale=.8,fill="#00acee")`  [g.baio@ucl.ac.uk](mailto:g.baio@ucl.ac.uk)
`r icons::icon_style(icons::fontawesome("firefox"),scale=.8,fill="#EA7600")`  [https://gianluca.statistica.it/](https://gianluca.statistica.it/)
`r icons::icon_style(icons::fontawesome("firefox"),scale=.8,fill="#EA7600")`  [https://egon.stats.ucl.ac.uk/research/statistics-health-economics/](https://egon.stats.ucl.ac.uk/research/statistics-health-economics/)
`r icons::icon_style(icons::fontawesome("github"),scale=.8,fill="black")`  [https://github.com/giabaio](https://github.com/giabaio)
`r icons::icon_style(icons::fontawesome("github"),scale=.8,fill="black")`  [https://github.com/StatisticsHealthEconomics](https://github.com/StatisticsHealthEconomics)
`r icons::icon_style(icons::fontawesome("twitter"),scale=.8,fill="#00acee")`  [@gianlubaio](https://twitter.com/gianlubaio)     
]

### `r rmarkdown::metadata$params`

<!--
Adds a departmental logo on the right-bottom corner (Only with 'ucl-stats')
-->
.logo-stats[]

<!--
Can also add sticky notes:
`r postit(text=paste0('Check out our departmental podcast "Random Talks" on Soundcloud!', add_podcast()),top="75%",left="2.5%",height="6.3em",width="6.3em")`

`r postit(text=paste0("Follow our departmental social media accounts", add_twitter(url="https://twitter.com/stats_ucl",title="@stats_UCL",fill="#00acee"), add_linkedin(url="https://www.linkedin.com/in/statistical-science-ucl-906b9a201",title="LinkedIn")),top="53%",left="6.5%",height="6.3em",width="6.3em")`
-->

<!-- This adds a footer (optional and with other possibilities...) 
     For example, can use `r samptux()` to add the Samp Tux log,
     or change the bottom space to align the text, etc
.footer-left[
<span style="position: relative; bottom: 0px; color: #D5D5D5;"> &nbsp; &copy; Gianluca Baio (UCL)</span>
]
--> 


---

layout: true

.my-footer[ 
.alignleft[
&nbsp; &copy; Gianluca Baio (UCL) `r add_twitter()` `r add_github()` `r add_email()` `r add_website()`
]
.aligncenter[
`r rmarkdown::metadata$title` 
]
.alignright[
`r course_site()` &nbsp; STAT0019 
]
] 

---

# Summary 

- Health economic evaluation    
   - What is and why do we need health economics?

- A framework for health economic evaluation    
   - Statistical modelling
   - Economic modelling
   - Decision analysis
   - Uncertainty analysis

- Standard vs Bayesian HTA    
   - Two-stage vs integrated approach

- Decision-making    
   - Cost-effectiveness plane; ICER; EIB
   
`r vspace("3rem")`
.content-box-beamer[
### **References** 

`r bmhe(c(1,3))`

`r bcea_book()`

`r esdm()`
]

---

# Health technology assessment (HTA) 

## Objective 
- Combine .red[costs] and .blue[benefits] of a given intervention into a rational scheme for allocating resources 
> *Health technology assessment (HTA) is a method of evidence synthesis that
considers evidence regarding clinical effectiveness, safety, cost-effectiveness and,
when broadly applied, includes social, ethical, and legal aspects of the use of health
technologies. The precise balance of these inputs depends on the purpose of each
individual HTA. A major use of HTAs is in informing reimbursement and coverage
decisions, in which case HTAs should include benefit-harm assessment and economic
evaluation.* .alignright[`r icon::academicons$pubmed` [Luce et al, 2010](https://pubmed.ncbi.nlm.nih.gov/20579285/)]
   
   .small[(Quote stolen from a brilliant presentation by [Cynthia Iglesias](https://www.york.ac.uk/healthsciences/our-staff/cynthia-iglesias/))]

`r vspace("-5px")`

--

##  A relatively new discipline
- Basically becomes "a thing" in the 1970s
- Arguably, a **historical accident**... 
   - Economists take the lead in developing the main theory $\Rightarrow$ *Health Economics*
   - But there's so much more to it (more on this later...)

`r vspace("-10px")`

--

## (Truly...) World-beating Britain
- Since its establishment, the **[National Institute for Health and Care Excellence](https://www.nice.org.uk/)** (originally: National Institute for Clinical Excellence, **NICE**), has gained prominence as the global powerhouse for HTA 

---

# Health technology assessment (HTA)

## NICE
- Established in 1999, during the first New Labour government
- Health Secretary Frank Dobson on whether it will work:
> *Probably not, but it's worth a bloody try!* 
  
   `r icon::academicons$pubmed` [Rawlins, 2009](https://pubmed.ncbi.nlm.nih.gov/19394075/)

.pull-right[
`r vspace("-220px")`
`r include_fig("dobson.jpg",width="45%",title="")` 
] 

--

- Main driver: tackle the inequalities and inefficiencies generated by the ".red[**postcode lottery**]"

   - Decisions about which drugs to fund through the NHS had historically been taken at a local level 
   - Concerns over the fact that patients in some areas of the country could access treatments that people elsewhere, sometimes in neighbouring streets, could not $\Rightarrow$ large inequalities in access to resources!

`r vspace("-20px")` 

- Ancillary objectives

   - Set quality standard *nationally* (although NICE is technically responsible for England & Wales only...)
   - De-politicise reimbursement/coverage decisions
   - Align with growing body of literature and experience in other countries ([PBAC](https://www.pbs.gov.au/info/industry/listing/participants/pbac) in Australia, [CADTH](https://www.cadth.ca/) in Canada, NZHTA in New Zealand,...)

---

count: false
# Health technology assessment (HTA)

## NICE &ndash; *influenzing* the outcomes... .alignright[`r icon::icon_style(icon::fontawesome("firefox"),scale=.8,fill="#EA7600")` [20 years of NICE](https://indepth.nice.org.uk/20-years-of-NICE/index.html)]

- The first drug appraisal was for the antiviral treatment for influenza, Relenza

- Specifically, NICE said that 
> *there was insufficient evidence to show Relenza reduced the severity of the illness for those most at risk, the elderly and people with asthma*

   and so concluded that it 
> *was not cost effective and should not be provided on the NHS*

`r vspace("50px")`

--

- This didn't go down very well with the manufacturer, with the then CEO Sir Richard Sykes reportedly threatening that
> *if the decision is not reversed, Glaxo Wellcome would consider leaving the UK*

`r vspace("50px")`
- Eventually, Relenza *was* made available on the NHS, but only with a limited basis (restricted population)

---

# Health technology assessment (HTA)

## NICE &ndash; *teething problems* .alignright[`r icon::icon_style(icon::fontawesome("firefox"),scale=.8,fill="#EA7600")` [20 years of NICE](https://indepth.nice.org.uk/20-years-of-NICE/index.html)]

.pull-left[
`r include_fig("wisdom-tooth.jpeg",width="100%",title="")`
]

.pull-right[

- The first full technology appraisal recommended that 
> *healthy wisdom teeth should not be removed as a precaution which was estimated might save the NHS £5m a year*

- Very quickly got traction in the media as decisions would be (politically) sensitive &ndash; one way or the other...

] 


---

# Health technology assessment (HTA)

## NICE &ndash; Courting controversy

.pull-left[
`r include_fig("daily-mail.png",width="100%",title="")` 
]
.pull-right[
- The Evaluation consultation document says
> *There were no statistically significant differences in quality of life between the ataluren and placebo groups. The company stated there was a positive trend towards improved quality of life with ataluren 40 mg/kg daily in the physical functioning subscale. The company submission also described a positive effect on school functioning and a negative trend in emotional and social subscales*

- Estimated total cost per person per year of treatment with ataluren of £220,256
- This is hugely affected by the uncertainty in the evidence and assumptions enconded in the model presented for assessment!
]


---

# Health technology assessment (HTA)

**Objective**: Combine .red[costs] and .blue[benefits] of a given intervention into a rational scheme for allocating resources 

--

`r include_fig("hta-scheme1.png",width="80%",title="")`

---

count: false
# Health technology assessment (HTA)

**Objective**: Combine .red[costs] and .blue[benefits] of a given intervention into a rational scheme for allocating resources 


`r include_fig("hta-scheme2.png",width="80%",title="")`

---

count: false
# Health technology assessment (HTA)

**Objective**: Combine .red[costs] and .blue[benefits] of a given intervention into a rational scheme for allocating resources 

`r include_fig("hta-scheme3.png",width="80%",title="")`

---

count: false
# Health technology assessment (HTA)

**Objective**: Combine .red[costs] and .blue[benefits] of a given intervention into a rational scheme for allocating resources 


`r include_fig("hta-scheme4.png",width="80%",title="")`

---

# "Standard"/historical approach to HTA

### Two-stage

`r vspace("-25px")`

```{r,engine='tikz', echo=F, out.width="85%",opts=list(width="75%",title="INSERT TEXT HERE"),eval=FALSE}
\usetikzlibrary{shapes,arrows,decorations.pathreplacing,positioning,calc}
\definecolor{olive}{rgb}{.2 .31 .09}
\newcommand\red{\color{red}}
\newcommand\black{\color{black}}

\begin{tikzpicture}%[->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin]
\hspace{-.5cm}
\draw(-5,-1) node[align=center,rectangle,rounded corners=2ex,draw,fill=red,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=2.2cm,minimum height=1cm](1){Statistical\\ model};

\draw(0.5,-1) node[align=center,rectangle,rounded corners=2ex,draw,fill=gray,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=2.2cm,minimum height=1cm](2){Economic\\ model};

\draw(4,-1) node[align=center,rectangle,rounded corners=2ex,draw,fill=orange,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=2.2cm,minimum height=1cm](3){Decision\\ analysis};

\draw(-5,2) node[align=center,rectangle,rounded corners=2ex,draw,fill=blue!40,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=2.2cm,minimum height=1cm](4){Uncertainty\\ analysis};

\draw(-5.2,-2.75) node[align=center,rectangle,rounded corners,draw=none,font=\sffamily\tiny,text width=3cm](5){
\begin{itemize}
\item Estimates relevant \textbf{population} parameters $\boldsymbol\theta$
\item Varies with the type of available data (\& statistical approach!)
\end{itemize}
};

\draw(0.3,-2.7) node[align=center,rectangle,rounded corners,draw=none,font=\sffamily\tiny,text width=3.5cm](6){
\begin{itemize}
\item Combines the parameters to obtain a population average measure for costs and clinical benefits
\item Varies with the type of available data \& statistical model used
\end{itemize}
};

\draw(3.8,-2.85) node[align=center,rectangle,rounded corners,draw=none,font=\sffamily\tiny,text width=3.5cm](7){
\begin{itemize}
\item Summarises the economic model by computing suitable measures of ``cost-effectiveness''
\item Dictates the best course of actions, given current evidence
\item Standardised process
\end{itemize}
};

\draw(-2.15,2.05) node[align=center,rectangle,rounded corners,draw=none,font=\sffamily\tiny,text width=3.7cm](8){
\begin{itemize}
\item Assesses the impact of uncertainty (eg in parameters or model structure) on the economic results
\item Mandatory in many jurisdictions (including NICE, in the UK)
\item Fundamentally Bayesian!
\end{itemize}
};

%\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (1.east) -- (2.west);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (2.east) -- (3.west);
\draw(1.0,3.5) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{6}{7}\selectfont]{\color{olive} 1.\ Estimation (base-case)};
%\draw(4.3,3.5) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{6}{7}\selectfont]{\color{olive} 2.\ Probabilistic sensitivity analysis};
\draw(1.8,3) node[align=center,draw,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{6}{7}\selectfont](9){$\theta$};
\draw(1.8,1) node[align=center,circle,draw,fill=none,font=\sffamily\fontsize{6}{7}\selectfont](10){$y$};
\draw(.5,1) node[align=center,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{6}{7}\selectfont](11){$p(y\mid \theta)$};
\draw(.5,3) node[align=center,draw,ellipse,double,fill=none,minimum width=.3cm,minimum height=.25cm,font=\sffamily\fontsize{6}{7}\selectfont](12){$\hat\theta=f(Y)$};

\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (9.south) -- (10.north);
\draw [dashed,->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (11.north) -- (12.south);
\draw [dashed,->,>=latex,shorten >=0pt,auto,node distance=3cm,thin,red!60] (12.220) to [out=220,in=130] (2.120);

\phantom{
\draw(4.3,3.5) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{6}{7}\selectfont]{\color{olive} 2.\ \textbf{Probabilistic sensitivity analysis}};
\draw(2.9,2.0) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{6}{7}\selectfont,color=red]{$\Rightarrow$};
\draw(5.4,3) node[align=center,circle,draw,fill=none,font=\sffamily\fontsize{6}{7}\selectfont](13){$\theta$};
\draw(4.2,3) node[align=center,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{6}{7}\selectfont](14){$p(\theta)\Rightarrow  g(\hat\theta)$};
\draw [dashed,->,>=latex,shorten >=0pt,auto,node distance=3cm,thin,blue!40] (13.south) to [out=270,in=45] (2.60);
}
\end{tikzpicture}
```

`r include_fig("unnamed-chunk-2-1.png",width="72%",title="")`

---

# 2./3. Economic modelling+Decision analysis 

### Base-case scenario

`r vspace("-10px")`

```{css echo=FALSE}
.big-left {
  width: 70%;
  float: left;
  margin-left: 50px;
}
.small-right{
  width: 20%;
  height: 92%;
  float: right;
  margin-right: 50px;
  margin-left: -30px;
  text-align: left!important;
}
```

.big-left[
```{r echo=F,fig.width=6,fig.height=6,out.width='50%',dev="tikz",opts=list(width="60%",title="INSERT TEXT HERE"),eval=FALSE}
library(BCEA)
library(ggplot2)
data(Vaccine)
m=bcea(e=e,c=c,ref=2)
df=data.frame(de=m$delta.e,dc=m$delta.c) %>% as_tibble() 
p=ggplot(data=df,aes(de,dc)) + geom_point(col="gray80",size=.4) + theme_classic() +
  theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      legend.position="none",
      panel.background=element_blank(),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      plot.background=element_blank()) +
  geom_hline(yintercept=0) + geom_vline(xintercept=0) +
  geom_segment(aes(x=0,y=-Inf,xend=0,yend=Inf),arrow=arrow(length=unit(0.30,"cm"),type = "closed")) +
  geom_segment(aes(x=-Inf,y=0,xend=Inf,yend=0),arrow=arrow(length=unit(0.30,"cm"),type = "closed")) + 
  geom_point(aes(x=mean(de),y=mean(dc)),col="red",size=2) +
  labs(title="Cost effectiveness plane",y="Cost differential",x="Effectiveness differential") +
  theme(plot.title = element_text(hjust = 0.5,size=18),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size=15)
  ) +
  annotate(
    "text",mean(df$de),mean(df$dc),
    label="$\\mbox{ICER}=\\frac{ {\\sf E}[\\Delta_c]}{ {\\sf E}[\\Delta_c]}=\\frac{\\hat\\mu_{c1}-\\hat\\mu_{c0}}{\\hat\\mu_{e1}-\\hat\\mu_{e0}}$",
    hjust=-.05, size=6
  ) +
  annotate(
    "text",mean(df$de),mean(df$dc),
    label="$\\phantom{\\mbox{ICER}}=\\mbox{Cost per outcome}$",
    hjust=-.05,vjust=2.5, size=6
  ) +
  annotate("text",0,Inf,label="$\\Delta_c$",hjust=2,vjust=1,size=5) +
  annotate("text",Inf,0,label="$\\Delta_e$",hjust=1,vjust=2,size=5) 
p
```

`r include_fig("unnamed-chunk-5-1.png",width="65%",title="")`
]
.small-right[
$$\class{myblue}{\Delta_e=}\class{red}{\underbrace{\class{myblue}{\E[e \mid \boldsymbol{\hat\theta}_1]}}_{\class{red}{\hat\mu_{e1}}}} \class{myblue}{-} \class{red}{\underbrace{\class{myblue}{\E[e \mid \boldsymbol{\hat\theta}_0]}}_{\class{red}{\hat\mu_{e0}}}}$$

$$\class{myblue}{\Delta_c=}\class{red}{\underbrace{\class{myblue}{\E[c \mid \boldsymbol{\hat\theta}_1]}}_{\class{red}{\hat\mu_{c1}}}} \class{myblue}{-} \class{red}{\underbrace{\class{myblue}{\E[c \mid \boldsymbol{\hat\theta}_0]}}_{\class{red}{\hat\mu_{c0}}}}$$
]

---

# Limitations of ICER
### The ICER is **not** an *ordered* statistic
- .blue[&ndash;200/200] better than .red[&ndash;100/200] better than .magenta[&ndash;100/100] in terms of decision, but ratios are $-\1$, $-\1/\2$, $-\1$
- ICERs in the NW quadrant indicate an intervention that is .green4[**dominated**] (\\(+\\) costs / $-$ effectiveness)

```{r icer-not-ordered, echo=FALSE,fig.width=6,fig.height=6,out.width='50%',dev="tikz",opts=list(width="60%",title="INSERT TEXT HERE"),eval=FALSE}
plot(0,0,xlim=c(-3,3),ylim=c(-3,3),axes=F,col="white",xlab="Effectiveness differential",ylab="Cost differential",mgp=c(0,0,0))
arrows(0,-3,0,3,angle=15,length=.1,lwd=2)
arrows(-3,0,3,0,angle=15,length=.1,lwd=2)
points(c(2,1,0),c(-2,-2,-2),lty=3,t="l")
points(c(2,1,0),c(-1,-1,-1),lty=3,t="l")
points(c(2,2,2),c(0,-1,-2),lty=3,t="l")
points(c(2,1,0),c(-1,-1,-1),lty=3,t="l")
points(c(1,1,1),c(0,-1,-1),lty=3,t="l")
points(c(0,-1,-1),c(1.5,1.5,1.5),lty=3,t="l")
points(c(-1,-1,-1),c(0,1,1.5),lty=3,t="l")
points(2,-2,pch=20,col="blue",cex=1.3)
points(2,-1,pch=20,col="red",cex=1.3)
points(1,-1,pch=20,col="magenta",cex=1.3)
points(-1,1.5,pch=20,col="green4",cex=1.3)
text(-1,1.5,"ICER=-1.5",pos=3,cex=.7)
text(2,-2,"ICER=-1",cex=.7,pos=4)
text(2,-1,"ICER=-1/2",cex=.7,pos=4)
text(1,-1,"ICER=-1",cex=.7,pos=1)
text(2,0,"200",pos=3,cex=.7)
text(1,0,"100",pos=3,cex=.7)
text(0,-1,"-100",pos=2,cex=.7)
text(0,-2,"-200",pos=2,cex=.7)
text(-1,0,"-100",pos=1,cex=.7)
text(0,1.5,"150",pos=4,cex=.7)
```

`r include_fig("icer-not-ordered-1.png",width="44%",title="")`

<style>
.green4 {
   color: #008b00;
}
</style>
---

# "Standard"/historical approach to HTA

### Two-stage

`r vspace("-25px")`

```{r,engine='tikz', echo=F, out.width="85%",opts=list(width="75%",title="INSERT TEXT HERE"),eval=FALSE}
\usetikzlibrary{shapes,arrows,decorations.pathreplacing,positioning,calc}
\definecolor{olive}{rgb}{.2 .31 .09}
\newcommand\red{\color{red}}
\newcommand\black{\color{black}}

\begin{tikzpicture}%[->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin]
\hspace{-.5cm}
\draw(-5,-1) node[align=center,rectangle,rounded corners=2ex,draw,fill=red,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=2.2cm,minimum height=1cm](1){Statistical\\ model};

\draw(0.5,-1) node[align=center,rectangle,rounded corners=2ex,draw,fill=gray,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=2.2cm,minimum height=1cm](2){Economic\\ model};

\draw(4,-1) node[align=center,rectangle,rounded corners=2ex,draw,fill=orange,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=2.2cm,minimum height=1cm](3){Decision\\ analysis};

\draw(-5,2) node[align=center,rectangle,rounded corners=2ex,draw,fill=blue!40,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=2.2cm,minimum height=1cm](4){Uncertainty\\ analysis};

\draw(-5.2,-2.75) node[align=center,rectangle,rounded corners,draw=none,font=\sffamily\tiny,text width=3cm](5){
\begin{itemize}
\item Estimates relevant \textbf{population} parameters $\boldsymbol\theta$
\item Varies with the type of available data (\& statistical approach!)
\end{itemize}
};

\draw(0.3,-2.7) node[align=center,rectangle,rounded corners,draw=none,font=\sffamily\tiny,text width=3.5cm](6){
\begin{itemize}
\item Combines the parameters to obtain a population average measure for costs and clinical benefits
\item Varies with the type of available data \& statistical model used
\end{itemize}
};

\draw(3.8,-2.85) node[align=center,rectangle,rounded corners,draw=none,font=\sffamily\tiny,text width=3.5cm](7){
\begin{itemize}
\item Summarises the economic model by computing suitable measures of ``cost-effectiveness''
\item Dictates the best course of actions, given current evidence
\item Standardised process
\end{itemize}
};

\draw(-2.15,2.05) node[align=center,rectangle,rounded corners,draw=none,font=\sffamily\tiny,text width=3.7cm](8){
\begin{itemize}
\item Assesses the impact of uncertainty (eg in parameters or model structure) on the economic results
\item Mandatory in many jurisdictions (including NICE, in the UK)
\item Fundamentally Bayesian!
\end{itemize}
};

%\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (1.east) -- (2.west);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (2.east) -- (3.west);
\draw(1.0,3.5) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{6}{7}\selectfont]{\color{olive} 1.\ Estimation (base-case)};
%\draw(4.3,3.5) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{6}{7}\selectfont]{\color{olive} 2.\ Probabilistic sensitivity analysis};
\draw(1.8,3) node[align=center,draw,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{6}{7}\selectfont](9){$\theta$};
\draw(1.8,1) node[align=center,circle,draw,fill=none,font=\sffamily\fontsize{6}{7}\selectfont](10){$y$};
\draw(.5,1) node[align=center,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{6}{7}\selectfont](11){$p(y\mid \theta)$};
\draw(.5,3) node[align=center,draw,ellipse,double,fill=none,minimum width=.3cm,minimum height=.25cm,font=\sffamily\fontsize{6}{7}\selectfont](12){$\hat\theta=f(Y)$};

\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (9.south) -- (10.north);
\draw [dashed,->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (11.north) -- (12.south);
\draw [dashed,->,>=latex,shorten >=0pt,auto,node distance=3cm,thin,red!60] (12.220) to [out=220,in=130] (2.120);

\draw(4.3,3.5) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{6}{7}\selectfont]{\color{olive} 2.\ \textbf{Probabilistic sensitivity analysis}};
\draw(2.9,2.0) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{6}{7}\selectfont,color=red]{$\Rightarrow$};
\draw(5.4,3) node[align=center,circle,draw,fill=none,font=\sffamily\fontsize{6}{7}\selectfont](13){$\theta$};
\draw(4.2,3) node[align=center,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{6}{7}\selectfont](14){$p(\theta)\red\leftrightarrow\black g(\hat\theta)$};
\draw [dashed,->,>=latex,shorten >=0pt,auto,node distance=3cm,thin,blue!40] (13.south) to [out=270,in=45] (2.60);

\end{tikzpicture}
```

`r include_fig("unnamed-chunk-3-1.png",width="75%",title="")` 

---

# 4. Uncertainty analysis .small[(**P**robabilistic **S**ensitivity **A**nalysis)]

### `r icon::icon_style(icon::fontawesome("exclamation-triangle"),fill="red")` Uncertainty induced by $g(\boldsymbol{\hat\theta}_0),g(\boldsymbol{\hat\theta}_1)$ &ndash; typically **independent** simulations 
`r vspace("-20px")`

.three-column[
### Statistical model
```{r echo=FALSE,fig.height=5,fig.width=2,dev="tikz",opts=list(width="50%")}
par(mfrow=c(3,1),mar=c(2.4,0,1.1,1))
plot(seq(0,1,.01),dbeta(seq(0,1,.01),20,80),axes=F,t="l",lwd=2,xlab="",ylab="")
axis(1)
text(.35,4,labels="$\\lambda_{12}$",cex=1.5)

plot(seq(0,1,.01),dbeta(seq(0,1,.01),15,10),axes=F,t="l",lwd=2,xlab="",ylab="")
axis(1)
text(.35,1.0,labels="$\\lambda_{13}$",cex=1.5)

plot(seq(0,1,.01),dbeta(seq(0,1,.01),5,7),axes=F,t="l",lwd=2,xlab="",ylab="")
axis(1)
text(.7,1.0,labels="$\\lambda_{23}$",cex=1.5)

```
]
.three-column[
### Economic model
`r vspace("50px")`
.center[
Status quo 
]

.content-box-gray[
`r include_fig("3state-2.png",width="100%")`
]

`r vspace("80px")`
.center[
New drug
]

.content-box-gray[
`r include_fig("3state-2.png",width="100%")`
]
]
.three-column[
### Decision analysis
```{r echo=FALSE}
library(kableExtra)
tab0=tibble(
  Benefits=c("741","699","...","726","716.2"),
  Costs=c("670382.1","871273.3","...","425822.2","790381.2")
)
tab1=tibble(
  Benefits=c("732","664","...","811","774.5"),
  Costs=c("1131978","1325654","...","766411.4","1066849.8")
)
```
```{r echo=FALSE}
tab0 %>% kable() %>%
  kable_classic() %>% 
  kable_styling(full_width = F,font_size = 12) %>% 
  add_header_above(c("Status quo"=2),background="white",bold=T) %>% 
  row_spec(0:nrow(tab0),background="white",align="c") %>% 
  # This hides the rows for the effect
  row_spec(1:nrow(tab0),color="white") %>% 
  row_spec(nrow(tab0),bold=TRUE) %>%
  row_spec(4,extra_css="border-bottom: 1px solid;") %>% 
  column_spec(1,width="35%") %>% column_spec(2,width="35%")
```

`r vspace("10px")`

```{r echo=FALSE}
tab1 %>% kable() %>%
  kable_classic() %>% 
  kable_styling(full_width = F,font_size = 12) %>% 
  add_header_above(c("New drug"=2),background="white",bold=T) %>% 
  row_spec(0:nrow(tab1),background="white",align="c") %>% 
  # This hides the rows for the effect
  row_spec(1:nrow(tab1),color="white") %>% 
  row_spec(nrow(tab1),bold=TRUE) %>%
  row_spec(4,extra_css="border-bottom: 1px solid;") %>% 
  column_spec(1,width="35%") %>% column_spec(2,width="35%")
```

]

---

count: false
# 4. Uncertainty analysis .small[(**P**robabilistic **S**ensitivity **A**nalysis)]

### `r icon::icon_style(icon::fontawesome("exclamation-triangle"),fill="red")` Uncertainty induced by $g(\boldsymbol{\hat\theta}_0),g(\boldsymbol{\hat\theta}_1)$ &ndash; typically **independent** simulations 
`r vspace("-20px")`

.three-column[
### Statistical model
```{r echo=FALSE,fig.height=5,fig.width=2,dev="tikz",opts=list(width="50%")}
par(mfrow=c(3,1),mar=c(2.4,0,1.1,1))
plot(seq(0,1,.01),dbeta(seq(0,1,.01),20,80),axes=F,t="l",lwd=2,xlab="",ylab="")
axis(1)
text(.35,4,labels="$\\lambda_{12}$",cex=1.5)
points(rbeta(1,20,80),par()$usr[3],pch=19,col="red",cex=1.5,lwd=3,xpd=T)

plot(seq(0,1,.01),dbeta(seq(0,1,.01),15,10),axes=F,t="l",lwd=2,xlab="",ylab="")
axis(1)
text(.35,1.0,labels="$\\lambda_{13}$",cex=1.5)
points(rbeta(1,15,10),par()$usr[3],pch=19,col="red",cex=1.5,lwd=3,xpd=T)

plot(seq(0,1,.01),dbeta(seq(0,1,.01),5,7),axes=F,t="l",lwd=2,xlab="",ylab="")
axis(1)
text(.7,1.0,labels="$\\lambda_{23}$",cex=1.5)
points(rbeta(1,5,7),par()$usr[3],pch=19,col="red",cex=1.5,lwd=3,xpd=T)

```
]
.three-column[
### Economic model
`r vspace("50px")`
.center[
Status quo 
]

.content-box-gray[
`r include_fig("3state-2.png",width="100%")`
]

`r vspace("80px")`
.center[
New drug
]

.content-box-gray[
`r include_fig("3state-2.png",width="100%")`
]
]
.three-column[
### Decision analysis
```{r echo=FALSE}
tab0 %>% kable() %>%
  kable_classic() %>% 
  kable_styling(full_width = F,font_size = 12) %>% 
  add_header_above(c("Status quo"=2),background="white",bold=T) %>% 
  row_spec(0:nrow(tab0),background="white",align="c") %>% 
  # This hides the rows for the effect
  row_spec(2:nrow(tab0),color="white") %>% 
  row_spec(nrow(tab0),bold=TRUE) %>%
  row_spec(4,extra_css="border-bottom: 1px solid;") %>% 
  column_spec(1,width="35%") %>% column_spec(2,width="35%")
```

`r vspace("10px")`

```{r echo=FALSE}
tab1 %>% kable() %>%
  kable_classic() %>% 
  kable_styling(full_width = F,font_size = 12) %>% 
  add_header_above(c("New drug"=2),background="white",bold=T) %>% 
  row_spec(0:nrow(tab1),background="white",align="c") %>% 
  # This hides the rows for the effect
  row_spec(2:nrow(tab1),color="white") %>% 
  row_spec(nrow(tab1),bold=TRUE) %>%
  row_spec(4,extra_css="border-bottom: 1px solid;") %>% 
  column_spec(1,width="35%") %>% column_spec(2,width="35%")

```

]

.arrow1[
$\rightarrow$
]

.arrow2[
$\rightarrow$
]

---

count: false
# 4. Uncertainty analysis .small[(**P**robabilistic **S**ensitivity **A**nalysis)]

### `r icon::icon_style(icon::fontawesome("exclamation-triangle"),fill="red")` Uncertainty induced by $g(\boldsymbol{\hat\theta}_0),g(\boldsymbol{\hat\theta}_1)$ &ndash; typically **independent** simulations 
`r vspace("-20px")`

.three-column[
### Statistical model
```{r echo=FALSE,fig.height=5,fig.width=2,dev="tikz",opts=list(width="50%")}
par(mfrow=c(3,1),mar=c(2.4,0,1.1,1))
plot(seq(0,1,.01),dbeta(seq(0,1,.01),20,80),axes=F,t="l",lwd=2,xlab="",ylab="")
axis(1)
text(.35,4,labels="$\\lambda_{12}$",cex=1.5)
points(rbeta(1,20,80),par()$usr[3],pch=19,col="red",cex=1.5,lwd=3,xpd=T)

plot(seq(0,1,.01),dbeta(seq(0,1,.01),15,10),axes=F,t="l",lwd=2,xlab="",ylab="")
axis(1)
text(.35,1.0,labels="$\\lambda_{13}$",cex=1.5)
points(rbeta(1,15,10),par()$usr[3],pch=19,col="red",cex=1.5,lwd=3,xpd=T)

plot(seq(0,1,.01),dbeta(seq(0,1,.01),5,7),axes=F,t="l",lwd=2,xlab="",ylab="")
axis(1)
text(.7,1.0,labels="$\\lambda_{23}$",cex=1.5)
points(rbeta(1,5,7),par()$usr[3],pch=19,col="red",cex=1.5,lwd=3,xpd=T)

```
]
.three-column[
### Economic model
`r vspace("50px")`
.center[
Status quo 
]

.content-box-gray[
`r include_fig("3state-2.png",width="100%")`
]

`r vspace("80px")`
.center[
New drug
]

.content-box-gray[
`r include_fig("3state-2.png",width="100%")`
]
]
.three-column[
### Decision analysis
```{r echo=FALSE}
tab0 %>% kable() %>%
  kable_classic() %>% 
  kable_styling(full_width = F,font_size = 12) %>% 
  add_header_above(c("Status quo"=2),background="white",bold=T) %>% 
  row_spec(0:nrow(tab0),background="white",align="c") %>% 
  # This hides the rows for the effect
  row_spec(3:nrow(tab0),color="white") %>% 
  row_spec(nrow(tab0),bold=TRUE) %>%
  row_spec(4,extra_css="border-bottom: 1px solid;") %>% 
  column_spec(1,width="35%") %>% column_spec(2,width="35%")
```

`r vspace("10px")`

```{r echo=FALSE}
tab1 %>% kable() %>%
  kable_classic() %>% 
  kable_styling(full_width = F,font_size = 12) %>% 
  add_header_above(c("New drug"=2),background="white",bold=T) %>% 
  row_spec(0:nrow(tab1),background="white",align="c") %>% 
  # This hides the rows for the effect
  row_spec(3:nrow(tab1),color="white") %>% 
  row_spec(nrow(tab1),bold=TRUE) %>%
  row_spec(4,extra_css="border-bottom: 1px solid;") %>% 
  column_spec(1,width="35%") %>% column_spec(2,width="35%")

```

]

.arrow1[
$\rightarrow$
]

.arrow2[
$\rightarrow$
]

---

count: false
# 4. Uncertainty analysis .small[(**P**robabilistic **S**ensitivity **A**nalysis)]
### `r icon::icon_style(icon::fontawesome("exclamation-triangle"),fill="red")` Uncertainty induced by $g(\boldsymbol{\hat\theta}_0),g(\boldsymbol{\hat\theta}_1)$ &ndash; typically **independent** simulations 
`r vspace("-20px")`

.three-column[
### Statistical model
```{r echo=FALSE,fig.height=5,fig.width=2,dev="tikz",opts=list(width="50%")}
par(mfrow=c(3,1),mar=c(2.4,0,1.1,1))
plot(seq(0,1,.01),dbeta(seq(0,1,.01),20,80),axes=F,t="l",lwd=2,xlab="",ylab="")
axis(1)
text(.35,4,labels="$\\lambda_{12}$",cex=1.5)
points(rbeta(1,20,80),par()$usr[3],pch=19,col="red",cex=1.5,lwd=3,xpd=T)

plot(seq(0,1,.01),dbeta(seq(0,1,.01),15,10),axes=F,t="l",lwd=2,xlab="",ylab="")
axis(1)
text(.35,1.0,labels="$\\lambda_{13}$",cex=1.5)
points(rbeta(1,15,10),par()$usr[3],pch=19,col="red",cex=1.5,lwd=3,xpd=T)

plot(seq(0,1,.01),dbeta(seq(0,1,.01),5,7),axes=F,t="l",lwd=2,xlab="",ylab="")
axis(1)
text(.7,1.0,labels="$\\lambda_{23}$",cex=1.5)
points(rbeta(1,5,7),par()$usr[3],pch=19,col="red",cex=1.5,lwd=3,xpd=T)

```
]
.three-column[
### Economic model
`r vspace("50px")`
.center[
Status quo 
]

.content-box-gray[
`r include_fig("3state-2.png",width="100%")`
]

`r vspace("80px")`
.center[
New drug
]

.content-box-gray[
`r include_fig("3state-2.png",width="100%")`
]
]
.three-column[
### Decision analysis
```{r echo=FALSE}
tab0 %>% kable() %>%
  kable_classic() %>% 
  kable_styling(full_width = F,font_size = 12) %>% 
  add_header_above(c("Status quo"=2),background="white",bold=T) %>% 
  row_spec(0:nrow(tab0),background="white",align="c") %>% 
  # This hides the rows for the effect
  #row_spec(1:nrow(tab),color="white") %>% 
  row_spec(nrow(tab0),bold=TRUE) %>%
  row_spec(4,extra_css="border-bottom: 1px solid;") %>% 
  column_spec(1,width="35%") %>% column_spec(2,width="35%")
```

`r vspace("10px")`

```{r echo=FALSE}
tab1 %>% kable() %>%
  kable_classic() %>% 
  kable_styling(full_width = F,font_size = 12) %>% 
  add_header_above(c("New drug"=2),background="white",bold=T) %>% 
  row_spec(0:nrow(tab1),background="white",align="c") %>% 
  # This hides the rows for the effect
  #row_spec(1:nrow(tab),color="white") %>% 
  row_spec(nrow(tab1),bold=TRUE) %>%
  row_spec(4,extra_css="border-bottom: 1px solid;") %>% 
  column_spec(1,width="35%") %>% column_spec(2,width="35%")

```

`r vspace("-15px")`
\begin{align}
\class{myblue}{`r sftext("ICER")`} & \class{myblue}{=} \frac{\class{myblue}{`r sftext("276468.6")`}}{\class{myblue}{`r sftext("58.3")`}}\\
& \class{myblue}{= `r sftext("6497.1")`}
\end{align}
]

.arrow1[
$\rightarrow$
]

.arrow2[
$\rightarrow$
]

<style>
.arrow1 {
  position: fixed;
  top: 21.0%;
  left: 25%;
  width: 12%;
  text-align: center;
  color: black;
}

.arrow2 {
  position: fixed;
  top: 21.0%;
  left: 60%;
  width: 12%;
  text-align: center;
  color: black;
}
</style>

---


count: false

# 4. Uncertainty analysis*

.big-left[
```{r echo=F,fig.width=6,fig.height=6,out.width='50%',dev="tikz",opts=list(width="60%",title="INSERT TEXT HERE"),eval=FALSE}
# library(BCEA)
# library(ggplot2)
# data(Vaccine)
# m=bcea(e,c,ref=2)
# df=data.frame(de=m$delta.e,dc=m$delta.c)
p=ggplot(data=df,aes(de,dc)) + geom_point(col="gray20",size=.4) + theme_classic() +
  theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      legend.position="none",
      panel.background=element_blank(),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      plot.background=element_blank()) +
  geom_hline(yintercept=0) + geom_vline(xintercept=0) +
  geom_segment(aes(x=0,y=-Inf,xend=0,yend=Inf),arrow=arrow(length=unit(0.30,"cm"),type = "closed")) +
  geom_segment(aes(x=-Inf,y=0,xend=Inf,yend=0),arrow=arrow(length=unit(0.30,"cm"),type = "closed")) + 
  geom_point(aes(x=mean(de),y=mean(dc)),col="red",size=2) +
  labs(title="Cost effectiveness plane",y="Cost differential",x="Effectiveness differential") +
  theme(plot.title = element_text(hjust = 0.5,size=18),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size=15)
  ) +
  annotate("text",0,Inf,label="$\\Delta_c$",hjust=2,vjust=1,size=5) +
  annotate("text",Inf,0,label="$\\Delta_e$",hjust=1,vjust=2,size=5) 
p
```
`r include_fig("bootstrap.png",width="65%",title="")`
]
.small-right[
$$\class{myblue}{\Delta_e=}\class{red}{\underbrace{\class{myblue}{\E[e \mid \boldsymbol{\theta}_1]}}_{\class{red}{\mu_{e1}}}} \class{myblue}{-} \class{red}{\underbrace{\class{myblue}{\E[e \mid \boldsymbol{\theta}_0]}}_{\class{red}{\mu_{e0}}}}$$

$$\class{myblue}{\Delta_c=}\class{red}{\underbrace{\class{myblue}{\E[c \mid \boldsymbol{\theta}_1]}}_{\class{red}{\mu_{c1}}}} \class{myblue}{-} \class{red}{\underbrace{\class{myblue}{\E[c \mid \boldsymbol{\theta}_0]}}_{\class{red}{\mu_{c0}}}}$$

`r vspace("6rem")`

.small[
*Induced by $\class{myblue}{g(\boldsymbol{\hat\theta}_0),g(\boldsymbol{\hat\theta}_1)}$
]
]

---

exclude: true
name: whatswrong

# What's wrong with this?...


- Potential correlation between costs & clinical benefits .alignright[.orange[[**Individual level + Aggregated level Data**]]]
   - Strong positive correlation &ndash; effective treatments are innovative and result from intensive and lengthy research $\Rightarrow$ are associated with higher unit costs
   - Negative correlation - more effective treatments may reduce total care pathway costs e.g. by reducing hospitalisations, side effects, etc.
   - Because of the way in which standard models are set up, bootstrapping generally only approximates the underlying level of correlation &ndash; .olive[**MCMC does a better job!**]

--

exclude: true

- Joint/marginal normality not realistic .alignright[.orange[[**Mainly ILD**]]]
   - Costs usually skewed and benefits may be bounded in $[0; 1]$ 
   - Can use transformation (e.g. logs) &ndash; but care is needed when back transforming to the natural scale
   - Should use more suitable models (e.g. Beta, Gamma or log-Normal) &ndash; .olive[**generally easier under a Bayesian framework**]
   - Particularly relevant in presence of partially observed data &ndash; more on this later!

--

exclude: true

- Particularly as the focus is on decision-making (rather than just inference), we need to use **all** available evidence to fully characterise current uncertainty on the model parameters and outcomes .alignright[.orange[[**Mainly ALD**]]]
   - A Bayesian approach is helpful in combining different sources of information 
   - .olive[**Propagating uncertainty is a fundamentally Bayesian operation!**]

---

# **Bayesian** approach to HTA

### Integrated

`r vspace("-30px")`

```{r,engine='tikz', echo=F, out.width="85%",opts=list(width="75%",title="INSERT TEXT HERE"),eval=FALSE}
\usetikzlibrary{shapes,arrows,decorations.pathreplacing,positioning,calc}
\definecolor{olive}{rgb}{.2 .31 .09}
\newcommand\red{\color{red}}
\newcommand\black{\color{black}}
\newcommand\olive{\color{olive}}

\begin{tikzpicture}%[->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin]
\hspace{-.5cm}
\draw(-5,-1) node[align=center,rectangle,rounded corners=2ex,draw,fill=red,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=2.2cm,minimum height=1cm](1){Statistical\\ model};

\draw(0.5,-1) node[align=center,rectangle,rounded corners=2ex,draw,fill=gray,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=2.2cm,minimum height=1cm](2){Economic\\ model};
\draw(4,-1) node[align=center,rectangle,rounded corners=2ex,draw,fill=orange,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=2.2cm,minimum height=1cm](3){Decision\\ analysis};
\draw(-5,2) node[align=center,rectangle,rounded corners=2ex,draw,fill=blue!40,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=2.2cm,minimum height=1cm](4){Uncertainty\\ analysis};
\draw(-5.2,-2.75) node[align=center,rectangle,rounded corners,draw=none,font=\sffamily\tiny,text width=3cm](5){
\begin{itemize}
\item Estimates relevant \textbf{population} parameters $\boldsymbol\theta$
\item Varies with the type of available data (\& statistical approach!)
\end{itemize}
};
\draw(0.3,-2.7) node[align=center,rectangle,rounded corners,draw=none,font=\sffamily\tiny,text width=3.5cm](6){
\begin{itemize}
\item Combines the parameters to obtain a population average measure for costs and clinical benefits
\item Varies with the type of available data \& statistical model used
\end{itemize}
};
\draw(3.8,-2.85) node[align=center,rectangle,rounded corners,draw=none,font=\sffamily\tiny,text width=3.5cm](7){
\begin{itemize}
\item Summarises the economic model by computing suitable measures of ``cost-effectiveness''
\item Dictates the best course of actions, given current evidence
\item Standardised process
\end{itemize}
};

\draw(-2.15,2.05) node[align=center,rectangle,rounded corners,draw=none,font=\sffamily\tiny,text width=3.7cm](8){
\begin{itemize}
\item Assesses the impact of uncertainty (eg in parameters or model structure) on the economic results
\item Mandatory in many jurisdictions (including NICE, in the UK)
\item Fundamentally Bayesian!
\end{itemize}
};


\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (2.east) -- (3.west);
\draw(2.4,3.5) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{6}{7}\selectfont]{\color{olive}\textbf{Estimation \& PSA (one stage)}};
\draw(1.8,3) node[align=center,draw,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{6}{7}\selectfont](9){$\theta$};
\draw(1.8,1) node[align=center,circle,draw,fill=none,font=\sffamily\fontsize{6}{7}\selectfont](10){$y$};
\draw(.5,1) node[align=center,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{6}{7}\selectfont](11){$p(y\mid \theta)$};
\draw(.5,3) node[align=center,fill=none,minimum width=.3cm,minimum height=.25cm,font=\sffamily\fontsize{6}{7}\selectfont](12){$p(\theta)$};
\draw(4.0,3) node[align=center,fill=none,font=\sffamily\fontsize{6}{7}\selectfont](13){$p(\theta\mid y)$};

\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (9.south) -- (10.north);
\draw [dashed,->,>=latex,shorten >=0pt,auto,node distance=3cm,thin,color=red] (10.180) to [bend left=90] (9.180);
\draw [dashed,->,>=latex,shorten >=0pt,auto,node distance=3cm,thin,color=red] (9.east) -- (13.west);
\draw [dashed,->,>=latex,shorten >=0pt,auto,node distance=3cm,thin,blue!40] (13.320) to [out=290,in=65] (2.60);

\end{tikzpicture}
```

`r include_fig("unnamed-chunk-7-1.png",width="72%",title="")`

---

# 4. Uncertainty analysis .small[(**P**robabilistic **S**ensitivity **A**nalysis)]
### `r icon::icon_style(icon::fontawesome("exclamation-triangle"),fill="red")` Uncertainty induced by $\class{myblue}{p(\boldsymbol\theta\mid `r sftext("data")`)}$ &ndash; uses the **joint** posterior of all the parameters!
`r vspace("-20px")`

.three-column[
### Statistical model
```{r echo=FALSE,fig.height=5,fig.width=2,dev="tikz",opts=list(width="50%")}
par(mfrow=c(3,1),mar=c(2.4,0,1.1,1))
plot(seq(0,1,.01),dbeta(seq(0,1,.01),20,80),axes=F,t="l",lwd=2,xlab="",ylab="")
axis(1)
text(.35,4,labels="$\\lambda_{12}$",cex=1.5)
points(rbeta(1,20,80),par()$usr[3],pch=19,col="red",cex=1.5,lwd=3,xpd=T)

plot(seq(0,1,.01),dbeta(seq(0,1,.01),15,10),axes=F,t="l",lwd=2,xlab="",ylab="")
axis(1)
text(.35,1.0,labels="$\\lambda_{13}$",cex=1.5)
points(rbeta(1,15,10),par()$usr[3],pch=19,col="red",cex=1.5,lwd=3,xpd=T)

plot(seq(0,1,.01),dbeta(seq(0,1,.01),5,7),axes=F,t="l",lwd=2,xlab="",ylab="")
axis(1)
text(.7,1.0,labels="$\\lambda_{23}$",cex=1.5)
points(rbeta(1,5,7),par()$usr[3],pch=19,col="red",cex=1.5,lwd=3,xpd=T)

```
]
.three-column[
### Economic model
`r vspace("50px")`
.center[
Status quo 
]

.content-box-gray[
`r include_fig("3state-2.png",width="100%")`
]

`r vspace("80px")`
.center[
New drug
]

.content-box-gray[
`r include_fig("3state-2.png",width="100%")`
]
]
.three-column[
### Decision analysis
```{r echo=FALSE}
tab0 %>% kable() %>%
  kable_classic() %>% 
  kable_styling(full_width = F,font_size = 12) %>% 
  add_header_above(c("Status quo"=2),background="white",bold=T) %>% 
  row_spec(0:nrow(tab0),background="white",align="c") %>% 
  # This hides the rows for the effect
  #row_spec(1:nrow(tab),color="white") %>% 
  row_spec(nrow(tab0),bold=TRUE) %>%
  row_spec(4,extra_css="border-bottom: 1px solid;") %>% 
  column_spec(1,width="35%") %>% column_spec(2,width="35%")
```

`r vspace("10px")`

```{r echo=FALSE}
tab1 %>% kable() %>%
  kable_classic() %>% 
  kable_styling(full_width = F,font_size = 12) %>% 
  add_header_above(c("New drug"=2),background="white",bold=T) %>% 
  row_spec(0:nrow(tab1),background="white",align="c") %>% 
  # This hides the rows for the effect
  #row_spec(1:nrow(tab),color="white") %>% 
  row_spec(nrow(tab1),bold=TRUE) %>%
  row_spec(4,extra_css="border-bottom: 1px solid;") %>% 
  column_spec(1,width="35%") %>% column_spec(2,width="35%")

```

`r vspace("-15px")`
\begin{align}
\class{myblue}{`r sftext("ICER")`} & \class{myblue}{=} \frac{\class{myblue}{`r sftext("276468.6")`}}{\class{myblue}{`r sftext("58.3")`}}\\
& \class{myblue}{= `r sftext("6497.1")`}
\end{align}
]

.arrow1[
$\rightarrow$
]

.arrow2[
$\rightarrow$
]

---

# 2./4. Economic model + Uncertainty analysis* 

.big-left[
```{r echo=F,fig.width=6,fig.height=6,out.width='50%',dev="tikz",opts=list(width="65%",title="INSERT TEXT HERE"),eval=FALSE}
# library(BCEA)
# library(ggplot2)
# data(Vaccine)
# m=bcea(e,c,ref=2)
# df=data.frame(de=m$delta.e,dc=m$delta.c)
p=ggplot(data=df,aes(de,dc)) + geom_point(col="gray20",size=.4) + theme_classic() +
  theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      legend.position="none",
      panel.background=element_blank(),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      plot.background=element_blank()) +
  geom_hline(yintercept=0) + geom_vline(xintercept=0) +
  geom_segment(aes(x=0,y=-Inf,xend=0,yend=Inf),arrow=arrow(length=unit(0.30,"cm"),type = "closed")) +
  geom_segment(aes(x=-Inf,y=0,xend=Inf,yend=0),arrow=arrow(length=unit(0.30,"cm"),type = "closed")) + 
#  geom_point(aes(x=mean(de),y=mean(dc)),col="red",size=2) +
  labs(title="Cost effectiveness plane",y="Cost differential",x="Effectiveness differential") +
  theme(plot.title = element_text(hjust = 0.5,size=18),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size=15)
  ) +
  annotate("text",0,Inf,label="$\\Delta_c$",hjust=2,vjust=1,size=5) +
  annotate("text",Inf,0,label="$\\Delta_e$",hjust=1,vjust=2,size=5) 
p
```
`r include_fig("unnamed-chunk-8-1.png",width="65%",title="")`
]
.small-right[
$$\class{myblue}{\Delta_e=}\class{red}{\underbrace{\class{myblue}{\E[e \mid \boldsymbol{\theta}_1]}}_{\class{red}{\mu_{e1}}}} \class{myblue}{-} \class{red}{\underbrace{\class{myblue}{\E[e \mid \boldsymbol{\theta}_0]}}_{\class{red}{\mu_{e0}}}}$$

$$\class{myblue}{\Delta_c=}\class{red}{\underbrace{\class{myblue}{\E[c \mid \boldsymbol{\theta}_1]}}_{\class{red}{\mu_{c1}}}} \class{myblue}{-} \class{red}{\underbrace{\class{myblue}{\E[c \mid \boldsymbol{\theta}_0]}}_{\class{red}{\mu_{c0}}}}$$

`r vspace("6rem")`

.small[
*Induced by $\class{myblue}{p(\boldsymbol{\theta} \mid `r sftext("data")`)}$
]
]

---
count: false

# 3. Decision analysis

.big-left[
```{r echo=F,fig.width=6,fig.height=6,out.width='50%',dev="tikz",opts=list(width="65%",title="INSERT TEXT HERE"),eval=FALSE}
# library(BCEA)
# library(ggplot2)
# data(Vaccine)
# m=bcea(e,c,ref=2)
# df=data.frame(de=m$delta.e,dc=m$delta.c)
p=ggplot(data=df,aes(de,dc)) + geom_point(col="gray80",size=.4) + theme_classic() +
  theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      legend.position="none",
      panel.background=element_blank(),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      plot.background=element_blank()) +
  geom_hline(yintercept=0) + geom_vline(xintercept=0) +
  geom_segment(aes(x=0,y=-Inf,xend=0,yend=Inf),arrow=arrow(length=unit(0.30,"cm"),type = "closed")) +
  geom_segment(aes(x=-Inf,y=0,xend=Inf,yend=0),arrow=arrow(length=unit(0.30,"cm"),type = "closed")) + 
  geom_point(aes(x=mean(de),y=mean(dc)),col="red",size=2) +
  labs(title="Cost effectiveness plane",y="Cost differential",x="Effectiveness differential") +
  theme(plot.title = element_text(hjust = 0.5,size=18),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size=15)
  ) +
  annotate(
    "text",mean(df$de),mean(df$dc),
    label="$\\mbox{ICER}=\\frac{ {\\sf E}[\\Delta_c]}{ {\\sf E}[\\Delta_c]}=\\frac{ {\\sf E}[\\mu_{c1}]-{\\sf E}[\\mu_{c0}]}{ {\\sf E}[\\mu_{e1}]-{\\sf E}[\\mu_{e0}]}$",
    hjust=-.05, size=6
  ) +
  annotate(
    "text",mean(df$de),mean(df$dc),
    label="$\\phantom{\\mbox{ICER}}=\\mbox{Cost per outcome}$",
    hjust=-.05,vjust=2.5, size=6
  ) +
  annotate("text",0,Inf,label="$\\Delta_c$",hjust=2,vjust=1,size=5) +
  annotate("text",Inf,0,label="$\\Delta_e$",hjust=1,vjust=2,size=5) 
p
```
`r include_fig("unnamed-chunk-9-1.png",width="65%",title="")`
]
.small-right[
$$\class{myblue}{\Delta_e=}\class{red}{\underbrace{\class{myblue}{\E[e \mid \boldsymbol{\theta}_1]}}_{\class{red}{\mu_{e1}}}} \class{myblue}{-} \class{red}{\underbrace{\class{myblue}{\E[e \mid \boldsymbol{\theta}_0]}}_{\class{red}{\mu_{e0}}}}$$

$$\class{myblue}{\Delta_c=}\class{red}{\underbrace{\class{myblue}{\E[c \mid \boldsymbol{\theta}_1]}}_{\class{red}{\mu_{c1}}}} \class{myblue}{-} \class{red}{\underbrace{\class{myblue}{\E[c \mid \boldsymbol{\theta}_0]}}_{\class{red}{\mu_{c0}}}}$$
]

---

# Limitations of ICER (continued...)

### Equivalent ICERs can mean very different things! 
- $\color{red}(\E[\Delta_e], \E[\Delta_c]) = (\0.\0\0\0\5, \5)$, indicates that the new treatment produces on average an increase in effectiveness of 0.0005 units at the cost of extra £10 000 
- $\color{magenta}(\E[\Delta_e], \E[\Delta_c]) = (−\0.\0\0\0\5, −\5)$] indicates that the new intervention is less effective, but cheaper
- In both cases, ICER = £10 000

`r vspace("-40px")`
`r include_fig("icer-equivalent.png",width="44%",title="")`

---

# Decision-theoretic approach to HTA

- Analytic framework for decision-making in the face of uncertainty

- Considers a set of .red[**prescriptive**] axioms to ensure rationality in decision-making

- Identifies the best course of action given:   
   - .red[**Model specification**]
   - .red[**Current evidence**]

--

## **Process of rational decision-making**

1.  Describe uncertainty on all unknown quantities by means of a (possibly subjective) probability distribution $\class{myblue}{p(\boldsymbol\omega) = p(e, c \mid \boldsymbol\theta)p(\boldsymbol\theta)}$

2. For each intervention $t$, outcomes $o = (e, c)$ are valued by means of a pre-specified measure of utility $\class{myblue}{u(e, c; t)}$

3. Select as the most “cost-effective” the intervention that is associated with the maximum expected utility $\class{myblue}{\mathcal{U}^t = \E_\boldsymbol\omega [u(e, c; t)]}$


- Typical utility function in HTA: Monetary Net Benefit $\class{myblue}{u(e, c; t) = nb_t = ke_t − c_t}$
   - $k$ is the "willingness to pay", i.e. the .red[*cost per  extra unit of effectiveness gained*]
   - Fixed, .red[linear] form, which simplifies computations
   - Assumes decision-maker is *risk neutral*. Not necessarily true!

---

# Expected Incremental Benefit

- Under the MNB, the expected utility is 

\begin{align}
\class{myblue}{\mathcal{U}^t = \mathcal{NB}_t} & \class{myblue}{= \E_{\class{blue}{\boldsymbol\omega}}[u(e,c;t)]} \\
& \class{myblue}{= k\E_{\class{blue}{\boldsymbol\omega}}[e_t] - \E_{\class{blue}{\boldsymbol\omega}}[c_t]} \\
& \class{myblue}{= k\E_{\class{red}{\boldsymbol\theta}}[e\mid \boldsymbol\theta_t] - \E_{\class{red}{\boldsymbol\theta}}[c\mid \boldsymbol\theta_t] = k\E[\mu_{et}] - \E[\mu_{ct}]}
\end{align}
<p style="margin-left: 2em;"><b>NB</b>: The expectation is taken with respect to \(p(\boldsymbol\omega)\) so \(\mathcal{NB}_t\) is a pure number!</p>

--


- Assuming we are considering only two interventions $t=(0,1)$, decision-making can be effected by looking at the .red[Expected Incremental Benefit]
\begin{align}
\class{myblue}{`r sftext("EIB")`} & \class{myblue}{=  \mathcal{NB}_1-\mathcal{NB}_0} \\
& \class{myblue}{=  \left(k\E[\mu_{e1}]-\E[\mu_{c1}]\right) - \left(k\E[\mu_{e0}]-\E[\mu_{c0}]\right)} \\
& \class{myblue}{= k\E[\Delta_e] - \E[\Delta_c]}
\end{align}


--


- The reference treatment $t=1$ is more cost-effective than the comparator $t=0$ if 
\begin{equation}
\class{myblue}{`r sftext("EIB")`>0 \Rightarrow k>(<)\frac{\E[\Delta_c]}{\E[\Delta_e]} = `r sftext("ICER")` \quad `r sftext(" if ")` \E[\Delta_e]>(<)0}
\end{equation}

---

count: false
# ICER vs EIB

.pull-left[
`r include_fig("contour2_2.png",width="100%")`
]
.pull-right[
`r include_fig("contour2.png",width="100%")`
]

---

count: false
# ICER vs EIB
`r include_fig("chemo_INB.png",width="50%")`

---

# Summarising PSA

```{r echo=FALSE}
library(kableExtra)
options(knitr.kable.NA = "\\(\\ldots\\)")
set.seed(140873)
nb0=9685*round(rnorm(10000,7.5,3))
nb1=9685*round(rnorm(10000,8,3))
ib=nb1-nb0
show.col=4
tab=tibble(
   iter=c(format(seq(1,show.col),digits=0),NA,format(1000,digits=0)),
   pi0=c(format(rbeta(show.col,1,2),digits=3,nsmall=0),NA,format(rbeta(1,1,2),digits=3,nsmall=0)),
   rho=c(format(rbeta(show.col,1,2),digits=3,nsmall=0),NA,format(rbeta(1,1,2),digits=3,nsmall=0)),
   dots=rep("\\(\\ldots\\)",show.col+2),
   gamma=c(format(rbeta(show.col,1,2),digits=3,nsmall=0),NA,format(rbeta(1,1,2),digits=3,nsmall=0)),
   nb0=c(nb0[1:show.col],NA,nb0[10000]),
   nb1=c(nb1[1:show.col],NA,nb1[10000])
)
tab=tab %>% mutate(
   ib=c(ib[1:show.col],NA,ib[10000])
)

tab2=tab %>% mutate(nb0=as.character(nb0),nb1=as.character(nb1),ib=as.character(ib))
tab2=tab2 %>% add_row(
  iter="",
  pi0="",
  rho="",
  dots="Average",
  gamma="",
  nb0=paste0("\\(\\mathcal{NB}_0=\\)",format(mean(nb0),digits=2,nsmall=2)),
  nb1=paste0("\\(\\mathcal{NB}_1=\\)",format(mean(nb1),digits=2,nsmall=2)),
  ib=paste0("\\(\\eib=\\)",format(mean(ib),digits=2,nsmall=2))
)

italics1=tab$nb1>tab$nb0; italics1[is.na(italics1)]=FALSE
italics0=tab$nb0>tab$nb1; italics0[is.na(italics0)]=FALSE
tab2 %>% select(iter,pi0,rho,gamma,dots,everything()) %>% kable(col.names=c(
   "Iteration","\\(\\lambda_1\\)","\\(\\lambda_2\\)","\\(\\lambda_3\\)","\\(\\ldots\\)",
   "\\(\\nb_0(\\boldsymbol\\theta)\\)","\\(\\nb_1(\\boldsymbol\\theta)\\)","\\(\\ib(\\boldsymbol\\theta)\\)"
   ), align="c"
   ) %>% kable_classic() %>%
   column_spec(1:5,width="1.2cm") %>% 
   kable_styling(full_width=T) %>% 
   add_header_above(c(" "=1,"Parameter simulations"=4,"Expected utility"=2," "=1)) %>% 
   row_spec(nrow(tab2),extra_css="border-bottom: 2px black solid;") %>% 
   row_spec(nrow(tab2)-1,extra_css="border-bottom: 2px black solid;") %>% 
   column_spec(7,color=c(rep("black",(nrow(tab))),"magenta"),italic=c(italics1,TRUE),width="2.4cm") %>% 
   column_spec(6,italic=c(italics0,FALSE),width="2.4cm") %>% 
   column_spec(8,width="2.2cm")

```

`r vspace("20px")`
- $\color{blue}\nb_t(\boldsymbol\theta)=k\mu_{et}-\mu_{ct}$ is the "known distribution" utility

- $\color{blue}\ib(\boldsymbol\theta)=\nb_1(\boldsymbol\theta)-\nb_0(\boldsymbol\theta)$ is the incremental benefit (as a function of \\(\boldsymbol\theta\\))

- Can summarise uncertainty in the decision-making process using the **cost-effectiveness acceptability curve** 

$$\color{blue}\ceac=\Pr(\ib(\boldsymbol\theta)\mid `r sftext("data")`)>0$$

   - Upon varying $k$, this is the **probability** that the optimal decision would not be reversed by reducing uncertainty

---

# CE plane vs CEAC

.pull-left[
`r include_fig("contour2_2.png",width="100%")`
]
.pull-right[
`r include_fig("contour2.png",width="100%")`
]

---

count: false
# CE plane vs CEAC

`r include_fig("chemo_CEAC.png",width="50%")`

---

# Limitations of CEACs 

`r vspace("-15px")`

### More on this in `r ref_lecture("voi")`

`r vspace("-5px")`

.pull-left[
`r include_fig("ceacLimits1.png",width="80%")`

- $\E[\Delta_c]=$ £1 100; sd\\((\Delta_c)=\\) £1 100
- $\E[\Delta_e]=$ 0.05 ; sd\\((\Delta_e)=\\) 0.05
- $\Corr(\Delta_e,\Delta_c)=$ 0
- $\ceac =$ 0.53 (for $k=$ £25 000)

]


.pull-right[
`r include_fig("ceacLimits2.png",width="80%")`

- $\E[\Delta_c]=$ £11 100; sd\\((\Delta_c)=\\) £11 100
- $\E[\Delta_e]=$ 0.5 ; sd\\((\Delta_e)=\\) 0.5
- $\Corr(\Delta_e,\Delta_c)=$ 0
- $\ceac =$ 0.53 (for $k=$ £25 000)

]

---

# `BCEA` 

## A package for Bayesian health economics

### What is `BCEA` not?

- `BCEA` is **not** a package to automatically run a Bayesian analysis
   - It cannot build the health economic model for you
   - It does not prepare the data to be used in the model
   - It does not automatically run the MCMC simulations
   - It does not choose the prior distributions for you

--

### So what *is* it then?

- `BCEA`  provides a set of specific functions to systematically post-process the output of a Bayesian health economic model

- Uses `R` [http://cran.r-project.org/](http://cran.r-project.org/)
   -  Very good at interacting with standard MCMC software
   - `BUGS` [www.mrc-bsu.cam.ac.uk/bugs/winbugs/contents.shtml](www.mrc-bsu.cam.ac.uk/bugs/winbugs/contents.shtml)
   - `JAGS` [www.mcmc-jags.sourceforge.net/](www.mcmc-jags.sourceforge.net/)
   - .red[**Free**] and there is a very large community of contributors
   - Specifically designed for statistical analysis and has very good graphical capabilities

---

count: false

# `BCEA` 

## A package for Bayesian health economics

`r include_fig("bcea_scheme.png",width="70%",title="INCLUDE TEXT HERE")`

.small[.alignright[`r icon::fontawesome("arrow-circle-right")` [Next lecture](../05_ILD/index.html)]]