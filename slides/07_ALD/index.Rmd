---
title: "&#8291;7. Aggregated level data"
author: Gianluca Baio
institute: "[Department of Statistical Science](https://www.ucl.ac.uk/statistics/) | University College London"
params: 
   - conference: "STAT0019 - Bayesian Methods in Health Economics"
   - location: "UCL"
date: 
output:
  xaringan::moon_reader:
    includes: 
       in_header: "../assets/latex_macros.html" 
       ## This line adds a logo based on the format selected in the file 'assets/THEME/include_logo.html'
       ## NB: the actual options (eg placement of the logo and actual logo file) can be changed there
       ## There's also a script to manipulate the colouring scheme for the UCL logo (from a basic black/white one)
       after_body: "../assets/ucl-stats/insert-logo.html"
    seal: false
    yolo: no
    lib_dir: libs
    nature:
      beforeInit: ["https://platform.twitter.com/widgets.js"]
      highlightStyle: github
      highlightLines: yes
      countIncrementalSlides: no
      ratio: '16:9'
      titleSlideClass:
      - center
      - middle
    self_contained: false 
    css:
    - "../assets/ucl-stats.css"
---

```{r echo=F,message=FALSE,warning=FALSE,comment=NA}
# Sources the R file with all the relevant setup and commands
source("../assets/setup.R")

# Stuff from 'xaringanExtra' (https://pkg.garrickadenbuie.com/xaringanExtra)
# This allows the use of panels (from 'xaringanExtra')
xaringanExtra::use_panelset()
# This allows to copy code from the slides directly
xaringanExtra::use_clipboard()
# This freezes the frame for when there's a gif included
xaringanExtra::use_freezeframe()

# Defines the path to the file with the .bib entries (in case there are references)
bibfile=ReadBib("~/Dropbox/Perso/Office/CV/mypubs.bib",check = FALSE)
```

class: title-slide

# `r rmarkdown::metadata$title`

## `r rmarkdown::metadata$author`

### `r rmarkdown::metadata$institute`    

.title-small[
`r icons::icon_style(icons::fontawesome("envelope",style = "solid"),scale=.8,fill="#00acee")`  [g.baio@ucl.ac.uk](mailto:g.baio@ucl.ac.uk)
`r icons::icon_style(icons::fontawesome("firefox"),scale=.8,fill="#EA7600")`  [https://gianluca.statistica.it/](https://gianluca.statistica.it/)
`r icons::icon_style(icons::fontawesome("firefox"),scale=.8,fill="#EA7600")`  [https://egon.stats.ucl.ac.uk/research/statistics-health-economics/](https://egon.stats.ucl.ac.uk/research/statistics-health-economics/)
`r icons::icon_style(icons::fontawesome("github"),scale=.8,fill="black")`  [https://github.com/giabaio](https://github.com/giabaio)
`r icons::icon_style(icons::fontawesome("github"),scale=.8,fill="black")`  [https://github.com/StatisticsHealthEconomics](https://github.com/StatisticsHealthEconomics)
`r icons::icon_style(icons::fontawesome("twitter"),scale=.8,fill="#00acee")`  [@gianlubaio](https://twitter.com/gianlubaio)     
]

### `r rmarkdown::metadata$params`

<!--
Adds a departmental logo on the right-bottom corner (Only with 'ucl-stats')
-->
.logo-stats[]

<!--
Can also add sticky notes:
`r postit(text=paste0('Check out our departmental podcast "Random Talks" on Soundcloud!', add_podcast()),top="75%",left="2.5%",height="6.3em",width="6.3em")`

`r postit(text=paste0("Follow our departmental social media accounts", add_twitter(url="https://twitter.com/stats_ucl",title="@stats_UCL",fill="#00acee"), add_linkedin(url="https://www.linkedin.com/in/statistical-science-ucl-906b9a201",title="LinkedIn")),top="53%",left="6.5%",height="6.3em",width="6.3em")`
-->

<!-- This adds a footer (optional and with other possibilities...) 
     For example, can use `r samptux()` to add the Samp Tux log,
     or change the bottom space to align the text, etc
.footer-left[
<span style="position: relative; bottom: 0px; color: #D5D5D5;"> &nbsp; &copy; Gianluca Baio (UCL)</span>
]
--> 


---

layout: true

.my-footer[ 
.alignleft[
&nbsp; &copy; Gianluca Baio (UCL) `r add_twitter()` `r add_github()` `r add_email()` `r add_website()`
]
.aligncenter[
`r rmarkdown::metadata$title` 
]
.alignright[
`r course_site()` &nbsp; STAT0019 
]
] 

---

# Summary

- Role of evidence synthesis in decision modelling
   - Absolute and relative effects

- Meta-analysis of aggregated summaries from RCTs
   - Multi-level hierarchical models
   - Exchangeability: No/Partial/Complete pooling
   - Magnesium example
   
- Evidence synthesis in health economics
   - Influenza example

`r vspace("3em")`

.content-box-beamer[
### **References** 

`r vspace("20px")`

`r bugs_book(10)`

`r bmhe(5.3)`

`r icon::icon_style(icon::fontawesome("firefox"),fill="orange")` [NICE DSU Evidence Synthesis Technical Support Document Series](http://www.nicedsu.org.uk)    

`r esdm()`

`r gelman_hill()`
]

---

# Evidence-based decisions

- Robust healthcare decisions should:
   - Consider all costs and benefits over a patients lifetime
   - Be evidence-based, reflecting all relevant evidence
   
- Economic evaluation based on individual level data from a single RCT
   - May not capture longer-term costs/benefits
   - May not generalise to other populations/settings
   - May not be the only relevant source of evidence... results may differ if we use another source

--


- **Need to identify all relevant evidence**
   - Transparent, reproducible, specific
   
- Systematic review
   - Population (including subgroups)
   - Interventions
   - Comparators
   - Outcomes

---

# ("Standard") Statistical modelling

`r vspace("-8px")`

1. Build a population level model (eg decision tree/Markov model)

  ```{r,engine='tikz', echo=F, out.width="85%",opts=list(width="75%",title="INSERT TEXT HERE"),eval=FALSE}
  \definecolor{myblue}{rgb}{0.14 0.34 0.55}
  
  \begin{tikzpicture}
  \draw(-6,1) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}
  {8}\selectfont](1){Prophylactic NIs?};
  
  \draw(-3,-1) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](2){No};
  
  \draw(-3,3) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](3){Yes};
  
  \draw(0,4) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](4){Yes \\$(p_1)$};
  
  \draw(0,2) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](5){No \\$(1-p_1)$};
  
  \draw(3,4) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](6){Cost with NIs + cost influenza};
  
  \draw(3,2) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](7){Cost with NIs};
  
  \draw(0,0) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](8){Yes \\$(p_0)$};
  
  \draw(0,-2) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](9){No \\$(1-p_0)$};
  
  \draw(3,0) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](10){Cost influenza};
  
  \draw(3,-2) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](11){Cost with no NIs};
  
  \draw(3,4.8) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](12){\underline{Outcomes}};
  
  \node [rectangle,minimum size=1.5mm,inner sep=0pt,outer sep=3pt,fill=black] at (-4.75,1) (dec1){};
  \node [circle,minimum size=1.5mm,inner sep=0pt,outer sep=3pt,fill=black] at (-2.65,3) (rand2){};
  \node [circle,minimum size=1.5mm,inner sep=0pt,outer sep=3pt,fill=black] at (-2.68,-1) (rand3){};
  
  \draw(-10.7,0) node[align=left,draw=none,font=\fontsize{8}{9}\selectfont,color=myblue](13){$\mu_{e1}=-lp_1$};
  \draw(-10.7,-.5) node[align=left,draw=none,font=\fontsize{8}{9}\selectfont,color=myblue](14){$\mu_{e0}=-lp_0$};
  \draw(-9.1,-1) node[align=left,draw=none,font=\fontsize{8}{9}\selectfont,color=myblue](15){$\mu_{c1}=\left(c^{\rm{\it NI}}+c^{\rm{\it Inf}}\right)p_1 + c^{\rm{\it NI}}(1-p_1)$};
  \draw(-9.1,-1.5) node[align=left,draw=none,font=\fontsize{8}{9}\selectfont,color=myblue](16){$\mu_{c0}=\left(c^{\rm{\it NI}}+c^{\rm{\it Inf}}\right)p_0 + c^{\rm{\it NI}}(1-p_0)$};
  
  \draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (1.east) |- (2.west);
  \draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (1.east) |- (3.west);
  \draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (3.east) |- (4.west);
  \draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (3.east) |- (5.west);
  \draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (2.east) |- (8.west);
  \draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (2.east) |- (9.west);
  \end{tikzpicture}
  ```

`r include_fig("decision-tree-1.png",width="75%")`
  
**NB**: in this case, the "data" are typically represented by summary statistics for the parameters of interest $\bm\theta= (p_0 , p_1 , l, \ldots)$, but may also have access to a combination of ILD and summaries

--

`r vspace("20px")`

<ol style="counter-reset: my-awesome-counter 1;">
<li> Use point estimates for the parameters to build the “base-case” (average) evaluation</li>

<li>Use resampling methods (eg bootstrap) to propage uncertainty in the point estimates and perform uncertainty analysis</li>
</ol>


---

# What's wrong with this?... .subtitle[(cfr. `r ref_lecture("intro_he","whatswrong")`)]

.lightgray[
- Potential correlation between costs & clinical benefits .alignright[.lightgray[[**Individual level + Aggregated level Data**]]]
   - Strong positive correlation - effective treatments are innovative and result from intensive and lengthy research $\Rightarrow$ are associated with higher unit costs
   - Negative correlation - more effective treatments may reduce total care pathway costs e.g. by reducing hospitalisations, side effects, etc.
   - Because of the way in which standard models are set up, bootstrapping generally only approximates the underlying level of correlation - .lightgray[**MCMC does a better job!**]
]


.lightgray[
- Joint/marginal normality not realistic .alignright[.lightgray[[**Mainly ILD**]]]
   - Costs usually skewed and benefits may be bounded in $[0; 1]$ 
   - Can use transformation (e.g. logs) - but care is needed when back transforming to the natural scale
   - Should use more suitable models (e.g. Beta, Gamma or log-Normal) - .lightgray[**generally easier under a Bayesian framework**]
   - Particularly relevant in presence of partially observed data - more on this later!
]


- Particularly as the focus is on decision-making (rather than just inference), we need to use **all** available evidence to fully characterise current uncertainty on the model parameters and outcomes .alignright[.orange[**Mainly ALD**]]
   - A Bayesian approach is helpful in combining different sources of information 
   - .olive[**Propagating uncertainty is a fundamentally Bayesian operation!**]

---

# *Absolute* vs *Relative* effects

- .blue[**Absolute**] effects
   - e.g. probabilities, mean scores, event rates
   - Typically whats needed in a decision model

- .red[**Relative**] effects
   - e.g. log-odds ratio, mean difference, hazard ratio
   - By design RCTs provide evidence on relative effects
   - $\ldots$ relative effects more generalisable than the absolute effects

--

`r vspace("-10px")`

**Goal**: Apply relative effects to reference absolute effect to obtain absolute effects

- $`r sftext("mean")`_1 = `r sftext("mean")`_0 + `r sftext("mean difference")`$

- $`r sftext("log-odds")`_1 = `r sftext("log-odds")`_0 + `r sftext("log-odds ratio")`$

- $\logit(p_1) = \logit(p_0) + \log `r sftext("OR")`$
   - Transform from log-odds, $\mu$, to probability, $p$, using inverse logit (sometimes called "expit"):
   $$p = \displaystyle\frac{e^\mu}{1+e^\mu} \iff \mu = \logit(p) = \log\left(\frac{p}{1-p}\right)$$
 
`r vspace("-25px")`  
- $`r sftext("log-hazard")`_1 = `r sftext("log-hazard")`_0 + \log `r sftext("HR")`$ 

**NB**: we need to fully propagate the uncertainty in the relative to the absolute effect! (Being Bayesian makes life **much** easier!)

---

# Exchangeability and pooling

## No pooling

`r include_fig("NoPooling.png",width="65%",title="TEXT")`

`r vspace("2em")`
- Assumes that relative effects from different studies are .blue[**independent**]
   - Not much use for economic modelling, unless only a single study is relevant

---

count: false

# Exchangeability and pooling

## Complete pooling

`r include_fig("CompletePooling.png",width="65%",title="TEXT")`

`r vspace("2em")`
-  Assumes that all studies (and all data points!) are .red[**exchangeable**]
   - They are "similar" &ndash; all come from the same data generating process
   - DGP depends on a single parameter $\theta$

---

count: false

# Exchangeability and pooling

## Complete pooling

.pull-left[
`r vspace("4em")`

- Statistical homogeneity

- Often called "**Fixed Effect**" model

- $\ldots$ or "**Common Effect**" model
]
.pull-right[
`r vspace("-20px")`
```{r,engine='tikz', echo=F, out.width="85%",opts=list(width="65%",title="INSERT TEXT HERE"),eval=FALSE}
\definecolor{myblue}{rgb}{0.14 0.34 0.55}
\begin{tikzpicture}
\draw[ultra thick] (4,2) -- (4,-4);
\draw (4,1) -- (5.7,1);
\node [circle,minimum size=1.5mm,inner sep=0pt,outer sep=3pt,fill=myblue] at (5.7,1) (rand1){};
\draw (3.5,0) -- (4,0);
\node [circle,minimum size=1.5mm,inner sep=0pt,outer sep=3pt,fill=myblue] at (3.5,0) (rand2){};
\draw (4,-1.5) -- (4.5,-1.5);
\node [circle,minimum size=1.5mm,inner sep=0pt,outer sep=3pt,fill=myblue] at (4.5,-1.5) (rand3){};
\draw (4,-2) -- (4.3,-2);
\node [circle,minimum size=1.5mm,inner sep=0pt,outer sep=3pt,fill=myblue] at (4.3,-2) (rand4){};
\draw (2.8,-2.8) -- (4,-2.8);
\draw (3.4,-2.8) node(line){};
\node [circle,minimum size=1.5mm,inner sep=0pt,outer sep=3pt,fill=myblue] at (2.8,-2.8) (rand5){};
\draw (4,-3.5) -- (4.8,-3.5);
\node [circle,minimum size=1.5mm,inner sep=0pt,outer sep=3pt,fill=myblue] at (4.8,-3.5) (rand6){};

\draw(4,-4.3) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](1){True effect, $\theta$};
\draw(2,-1.8) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](2){Result, $y_i$};
\draw(2.4,1) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](3){Random \\ error};

\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (2.310) -- (rand5.120);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (3.270) -- (line.90);
\end{tikzpicture}
```

`r include_fig("comp-pool.png",width="60%")`

]

---

count: false

# Exchangeability and pooling

## Partial pooling

`r include_fig("Hierarchical.png",width="65%",title="TEXT")`

`r vspace("1.0em")`
- **Compromise**
   - Data inform a study-specific parameter
   - But all study-specific parameters are also exchangeable ("similar") and inform an "overall" parameter $\phi$

---

count: false

# Exchangeability and pooling

## Partial pooling

.pull-left[
`r vspace("4em")`

- Statistical heterogeneity

- Often called "**Random Effect**" model

-  Estimate mean effect across studies and between study sd
]
.pull-right[
`r vspace("-30px")`
`r include_fig("normal_RE.png",width="85%",title="TEXT")`
]

---

name: shrinkage-slide
# Partial pooling/hierarchical modelling

- Partial pooling implies .red[hierarchical priors]

$$\class{myblue}{p(\theta_1,\theta_2,\ldots,\theta_J,\phi) = p(\phi) \prod_{j=1}^{J} p(\theta_j\mid\phi)}$$

- In a hierarchical model, the parameters are correlated $\Rightarrow$ lower number of effective
parameters!
 
- "Shrinkage"
   - `r icon::fontawesome("arrow-circle-right")` See [this slide](#shrinkage-plot)

```{r echo=FALSE}
library(R2jags)
library(R2OpenBUGS)
```

---

# Example (Magnesium trial)

- Meta-analysis of 16 trials of magnesium vs placebo for patients with myocardial infarction 

```{r echo=FALSE}
trials=tibble(
  trial=seq(1,16),
  trial_name=c(
    "Morton",
     "Rasmussen",
    "Smith",
    "Abraham",
    "Felstedt",
    "Shechter",
    "Ceremuzynski",
    "Bertschat",
    "Singh",
    "Pereira",
    "Shechter 1",
    "Golf",
    "Thorgersen",
    "LIMIT-2",
    "Shechter 2",
    "ISIS-4"
  ),
  year=c(
     1984,
     1986,
     1986,
     1987,
     1988,
     1989,
     1989,
     1989,
     1990,
     1990,
     1991,
     1991,
     1991,
     1992,
     1995,
     1995
  ),
  deaths_mag=c(
     1,9,2,1,10,1,1,0,6,1,2,5,4,90,4,2216
  ),
  total_mag=c(
     40,135,200,48,150,59,25,22,76,27,89,23,130,1159,107,29011
  ),
  deaths_pl=c(
     2,23,7,1,8,9,3,1,11,7,12,13,8,118,17,2103
  ),
  total_pl=c(
     36,135,200,46,148,56,23,21,75,27,80,33,122,1157,108,29039
  )
)

trials %>% kable(bootstrap=TRUE,col.names=c("Trial","Trial name","Year","Deaths (\\(r_2\\))","Total (\\(n_2\\))","Deaths (\\(r_1\\))","Total (\\(n_1\\))")) %>%
  kable_classic() %>% 
  kable_styling(full_width = F,font_size = 14) %>% 
  row_spec(nrow(trials),color="blue") %>% 
  add_header_above(c(" "=3,"Magnesium"=2,"Placebo"=2),bold=TRUE,extra_css="border-top: 1px solid") %>% 
  row_spec(0,bold=T) %>% 
  row_spec(nrow(trials),extra_css="border-bottom: 1px solid; border-bottom-color: black;")
```

---

# The model

- For study $i$ in arm $k$ (for $k=1$: placebo or $k=2$: magnesium)

  $$\class{myblue}{r_{1i} \sim \dbin(\pi_{1i},n_{1i}) \qquad\qquad r_{2i} \sim \dbin(\pi_{2i},n_{2i})}$$
  
  $$\class{myblue}{\logit(\pi_{ki}) = \alpha_i \hspace{2.55cm} `r sftext("If ")` k=1}$$
  $$\class{myblue}{\logit(\pi_{ki}) = \alpha_i + \delta_i \qquad `r sftext("If ")` k=2}$$

   Common effect model: $\delta_i = d$

   Random effects model: $\delta_i \sim \dnorm(d, \sigma^2 )$

- Independent priors given to $\alpha_i , d, \sigma$

--

- Can easily obtain summary for OR

$$\class{myblue}{`r sftext("OR")` = e^d}$$

- For random effects model, can summarise in 2 ways:
   - Mean across all study effects, $d$
   - Prediction for a "new" population, exchangeable with included study populations:
   $$\class{myblue}{\delta_{pred} \sim \dnorm(d,\sigma^2)}$$

`r vspace("-30px")`
.small[More on this in `r icon::academicons$pubmed` [Higgins & Spiegelhater, 2002](https://pubmed.ncbi.nlm.nih.gov/11914302/)]
---


count: false

# The model

**No pooling** model

```
model{
  for(i in 1:ns) {		
  # Sampling distributions
    r1[i] ~ dbin(pi1[i], n1[i])	
    r2[i] ~ dbin(pi2[i], n2[i])
  # Model
    logit(pi1[i]) <- alpha[i]
    logit(pi2[i]) <- alpha[i] + delta[i]
  # Baselines
    alpha[i] ~ dnorm(0.0,1.0E-5)
  # Study-specific treatment effects
    delta[i] ~ dnorm(0.0,1.0E-5)
  }
}
```

---

count: false

# The model

**Random** effects model

```
model{
  for(i in 1:ns) {		
  # Sampling distributions
    r1[i] ~ dbin(pi1[i], n1[i])	
    r2[i] ~ dbin(pi2[i], n2[i])
  # Model
    logit(pi1[i]) <- alpha[i]
    logit(pi2[i]) <- alpha[i] + delta[i]
  # Baselines
    alpha[i] ~ dnorm(0.0,1.0E-5)
  # Random Effects
    delta[i] ~ dnorm(d, prec)
  }
  
  # Priors
  d ~ dnorm(0.0,1.0E-6) 
  sd ~ dunif(0,5)
  prec <- pow(sd,-2)

  # Summaries
  OR <- exp(d)
  delta.pred ~ dnorm(d, prec)
}
```

---

count: false

# The model

**Common** effects model

```
model{
  for(i in 1:ns) {		
  # Sampling distributions
    r1[i] ~ dbin(pi1[i], n1[i])	
    r2[i] ~ dbin(pi2[i], n2[i])
  # Model
    logit(pi1[i]) <- alpha[i]
    logit(pi2[i]) <- alpha[i] + delta[i]
  # Baselines
    alpha[i] ~ dnorm(0.0,1.0E-5)
  # "Degenerate" Random Effects
    delta[i] ~ dnorm(d, prec)
  }
  
  # Priors
  d ~ dnorm(0.0,1.0E-6) 
* sd <- 0     # No variance for the random effect (so not really random...)
  prec <- pow(sd,-2)

  # Summaries
  OR <- exp(d)
  delta.pred ~ dnorm(d, prec)
}
```

---

count: false

# The model

**Common** effects model

```
model{
  for(i in 1:ns) {		
  # Sampling distributions
    r1[i] ~ dbin(pi1[i], n1[i])	
    r2[i] ~ dbin(pi2[i], n2[i])
  # Model
    logit(pi1[i]) <- alpha[i]
    logit(pi2[i]) <- alpha[i] + d
  # Baselines
    alpha[i] ~ dnorm(0.0,1.0E-5)
  
    
  }
  
  # Priors
  d ~ dnorm(0.0,1.0E-6) 
  
  

  # Summaries
  OR <- exp(d)
  
}
```

---

name: dic-definition
# Results

```{r echo=FALSE,include=FALSE,cache=TRUE}
# Data list with all the trial results
data_mag=list(
  r1=trials$deaths_pl,
  n1=trials$total_pl,
  r2=trials$deaths_mag,
  n2=trials$total_mag,
  ns=nrow(trials)
)

# Initial values
inits <- NULL

# Sets the number of iterations, burnin and thinning
n.iter <- 10000
n.burnin <- 9500
n.thin <- 1

# Model code (Random effects)
model.string="
model{
  for(i in 1:ns) {        
  # Sampling distributions
    r1[i] ~ dbin(pi1[i], n1[i])    
    r2[i] ~ dbin(pi2[i], n2[i])
  # Model
    logit(pi1[i]) <- alpha[i]
    logit(pi2[i]) <- alpha[i] + delta[i]
  # Baselines
    alpha[i] ~ dnorm(0.0,1.0E-5)
  # Random Effects
    delta[i] ~ dnorm(d, prec)
  }
  # Priors
  d ~ dnorm(0.0,1.0E-6) 
  sd ~ dunif(0,5)
  prec <- pow(sd,-2)
  # Summaries
  OR <- exp(d)
  delta.pred ~ dnorm(d, prec)
}
"
tmpf=tempfile()
tmps=file(tmpf,"w")
cat(model.string,file=tmps)

# Parameters to be monitored
params1=c("delta","d","delta.pred","OR","sd","alpha")

# Runs the model
library(R2OpenBUGS)
inits=function(){
  list(alpha=rnorm(16),delta=rnorm(16),d=rnorm(1),sd=runif(1))
}
raneff <- bugs(data=data_mag,inits=inits,parameters.to.save=params1,model.file=tmpf,
           n.chains=2, n.iter, n.burnin, n.thin, DIC=TRUE)

# Model string (no pooling)
model.string="
model{
  for(i in 1:ns) {        
  # Sampling distributions
    r1[i] ~ dbin(pi1[i], n1[i])    
    r2[i] ~ dbin(pi2[i], n2[i])
  # Model
    logit(pi1[i]) <- alpha[i]
    logit(pi2[i]) <- alpha[i] + delta[i]
  # Baselines
    alpha[i] ~ dnorm(0.0,0.001)
  # Treatment effects
    delta[i] ~ dnorm(0,0.25)
  }
}
"
tmpf=tempfile()
tmps=file(tmpf,"w")
cat(model.string,file=tmps)

# Parameters to be monitored
params2=c("delta","alpha")

n.iter <- 10000
n.burnin <- 9500
n.thin <- 1
# Runs the model
inits=function(){
  list(alpha=rnorm(16),delta=rnorm(16))
}
comeff <- bugs(data=data_mag,inits=inits,parameters.to.save=params2,model.file=tmpf,
           n.chains=2, n.iter, n.burnin, n.thin, DIC=TRUE)


# Model code (Fixed effects)
model.string="
model{
  for(i in 1:ns) {        
  # Sampling distributions
    r1[i] ~ dbin(pi1[i], n1[i])    
    r2[i] ~ dbin(pi2[i], n2[i])
  # Model
    logit(pi1[i]) <- alpha[i]
    logit(pi2[i]) <- alpha[i] + d
  # Baselines
    alpha[i] ~ dnorm(0.0,1.0E-5)
  }
  # Priors
  d ~ dnorm(0.0,1.0E-6) 
  OR <- exp(d)
}
"
tmpf=tempfile()
tmps=file(tmpf,"w")
cat(model.string,file=tmps)

# Parameters to be monitored
params3=c("d","alpha","OR")

# Runs the model
inits=function(){
  list(alpha=rnorm(16),d=rnorm(1))
}

fixeff <- bugs(data=data_mag,inits=inits,parameters.to.save=params3,model.file=tmpf,
           n.chains=2, n.iter, n.burnin, n.thin, DIC=TRUE)

```

-  Results very different for random/common effect models

- Fixed effects model gives higher .blue[**Deviance Information Criterion**] (DIC) even allowing for model complexity

  $$\class{myblue}{\DIC = p_D + \overline{D(\bm\theta)} = D(\overline{\bm\theta}) + 2p_D}$$
  
  $\class{myblue}{\overline{D(\bm\theta)}} =$ model mean deviance (see `r ref_lecture("ild","model-selection")`)
  
  $\class{myblue}{D(\overline{\bm\theta})} =$ model deviance at the average value of parameters
  
  $\class{myblue}{p_D=\overline{D(\bm\theta)} - D(\overline{\bm\theta})} =$ "effective" number of model parameters (more on this later)
  
`r vspace("2em")`

```{r echo=FALSE}
results=tibble(
  model=c("Random effects","Common effects"),
  OR=c(paste0(format(raneff$summary["OR","mean"],digits=2,nsmall=2)," (",format(raneff$summary["OR","2.5%"],digits=2,nsmall=2)," - ",format(raneff$summary["OR","97.5%"],digits=2,nsmall=2),")"),
       paste0(format(fixeff$summary["OR","mean"],digits=2,nsmall=2)," (",format(fixeff$summary["OR","2.5%"],digits=2,nsmall=2)," - ",format(fixeff$summary["OR","97.5%"],digits=2,nsmall=2),")")),
  bet=c(paste0(format(raneff$summary["sd","mean"],digits=2,nsmall=2)," (",paste0(format(raneff$summary["sd","2.5%"],digits=2,nsmall=2)," - ",paste0(format(raneff$summary["sd","97.5%"],digits=2,nsmall=2),")")))," "),
  dbar=c(format(raneff$summary["deviance","mean"],digits=2,nsmall=1),format(fixeff$summary["deviance","mean"],digits=2,nsmall=1)),
  pd=c(format(raneff$pD,digits=2,nsmall=1),format(fixeff$pD,digits=2,nsmall=1)),
  dic=c(format(raneff$DIC,digits=2,nsmall=1),format(fixeff$DIC,digits=2,nsmall=1))
)

results %>% kable(bootstrap=TRUE,col.names=c("Model","OR (95% interval)","Between study sd (\\(\\sigma\\))","Posterior mean deviance (\\(\\overline{D}\\))","\\(p_D\\)","DIC"),align="llcccc") %>%
  kable_classic() %>% 
  kable_styling(full_width = F,font_size = 22) %>% 
  row_spec(0,extra_css="border-top: 1px solid") %>% 
  column_spec(4,width="20%") %>% 
  row_spec(nrow(results),extra_css="border-bottom: 1px solid")
```

---

count: false

# Results

```{r echo=FALSE,dev="tikz",fig.width=11,fig.height=8,opts=list(width="65%",title="INSERT TEXT HERE"),eval=FALSE}
toplot=as_tibble(raneff$sims.matrix) %>% select(contains("delta["),d,delta.pred) 
tp=tibble(
  mean=apply(toplot,2,mean),
  q1=apply(toplot,2,quantile,0.025),
  q2=apply(toplot,2,quantile,0.975)
) %>% 
  bind_cols(
    name=c(paste(trials$trial_name,trials$year),"posterior mean","predictive mean")
  ) %>% 
  select(name,everything()) %>% 
  mutate(model="Partial pooling",y=row_number()+.25)

toplot=as_tibble(comeff$sims.matrix) %>% select(contains("delta["))
tp2=tibble(
  mean=apply(toplot,2,mean),
  q1=apply(toplot,2,quantile,0.025),
  q2=apply(toplot,2,quantile,0.975)
) %>% 
  bind_cols(
    name=paste(trials$trial_name,trials$year)
  ) %>% 
  select(name,everything()) %>% 
  mutate(model="No pooling",y=row_number())

toplot=as_tibble(fixeff$sims.matrix) %>% select(d)
tp3=tibble(
  mean=apply(toplot,2,mean),
  q1=apply(toplot,2,quantile,0.025),
  q2=apply(toplot,2,quantile,0.975)
) %>% 
  bind_cols(
    name=""
  ) %>% 
  select(name,everything()) %>% 
  mutate(model="Complete pooling",y=17.25)


tp=tp %>% bind_rows(tp2) %>% mutate(y=case_when(y>17~y-.25,TRUE~y)) %>% bind_rows(tp3)

labs=c(paste0("$\\delta_{",1:16,"}$"),"$d$","$\\delta_{pred}$")
tp %>% ggplot()+geom_point(aes(x=mean,y=19-y,color=model),size=3) + theme_bw() +
  geom_segment(aes(x=q1,xend=q2,y=19-y,yend=19-y),linetype="dashed") +
  geom_vline(xintercept=0,size=1.2,linetype="dashed") +
  labs(x="log-odds ratio",y=NULL) + 
  scale_y_continuous(breaks=18:1,labels=c(paste(trials$trial_name,trials$year),"Posterior mean","Predictive mean")) + 
  theme(text=element_text(size=20),legend.title=element_blank()) +
  coord_cartesian(xlim=c(-4,4)) +
  annotate("text",x=4,y=18:1,label=labs,size=5)

# tp2 %>% ggplot()+geom_point(aes(x=mean,y=nrow(tp2):1),size=3,color="blue") + theme_bw() +
#   geom_segment(aes(x=q1,xend=q2,y=nrow(tp2):1,yend=nrow(tp2):1),linetype="dashed") +
#   geom_vline(xintercept=0,size=1.2,linetype="dashed") +
#   labs(x="log-odds ratio",y=NULL) + 
#   scale_y_continuous(breaks=nrow(tp2):1,labels=tp2$name) + 
#   theme(text=element_text(size=20)) +
#   xlim(-4.9,4)
#   
# tp %>% ggplot()+geom_point(aes(x=mean,y=nrow(tp):1-.25),size=3,color="blue") + theme_bw() +
#   geom_segment(aes(x=q1,xend=q2,y=nrow(tp):1-.25,yend=nrow(tp):1-.25),linetype="dashed") +
#   geom_vline(xintercept=0,size=1.2,linetype="dashed") +
#   labs(x="log-odds ratio",y=NULL) + 
#   scale_y_continuous(breaks=nrow(tp):1,labels=tp$name) + 
#   theme(text=element_text(size=20)) +
#   geom_point(data=tp2,aes(x=mean,y=nrow(tp):3),size=3,color="red") +
#   geom_segment(data=tp2,aes(x=q1,xend=q2,y=nrow(tp):3,yend=nrow(tp):3)) +
#   coord_cartesian(xlim=c(-4,4))

```

`r include_fig("log-odds-ratios.png",width="65%")`

---

name: shrinkage-plot
# Shrinkage

```{r echo=FALSE,dev="tikz",fig.width=11,fig.height=8,opts=list(width="65%",title="INSERT TEXT HERE"),eval=FALSE}
tp_ranef=tibble(
  x=raneff$summary[grep("alpha",rownames(raneff$summary)),"mean"],
  y=raneff$summary[grep("delta",rownames(raneff$summary))[1:16],"mean"],
  model="Partial pooling"
)
tp_indep=tibble(
  x=comeff$summary[grep("alpha",rownames(comeff$summary)),"mean"],
  y=comeff$summary[grep("delta",rownames(comeff$summary)),"mean"],
  model="No pooling"
)
tp2=tp_ranef %>% bind_rows(tp_indep)
tp3=tp_indep %>% rename(x_indep=x,y_indep=y) %>% select(-model) %>% 
  bind_cols(tp_ranef %>% rename(x_ranef=x,y_ranef=y) %>% select(-model)) %>% mutate(trial=row_number()) %>% 
  mutate(diff=case_when(y_indep>y_ranef~1,y_indep<=y_ranef~-1)) %>% 
  mutate(y_ranef2=y_ranef+diff*0.007)

ggplot()+geom_segment(data=tp3,aes(x=x_indep,y=y_indep,xend=x_ranef,yend=y_ranef2),arrow=arrow(length=unit(0.2,"cm"),type="closed")) +
  geom_point(data=tp2,aes(x,y,color=model),size=3) + theme_bw() + 
  labs(x="$\\alpha_i$",y="$\\delta_i$",title="Posterior means for the model parameters") +
  theme(text=element_text(size=20),legend.title=element_blank()) + 
  annotate("text",x=tp3$x_indep,y=tp3$y_indep,label=tp3$trial,size=5,hjust=1.7,vjust=0) +
  geom_point(aes(x=mean(tp3$x_indep),y=raneff$summary["d","mean"]),size=6,col="#F8766D") + #"gray") +
  annotate("text",x=mean(tp3$x_indep),y=raneff$summary["d","mean"],label="$d$",size=5,vjust=-1.5) + 
  scale_color_manual(label=c("No pooling","Partial pooling"),values=c("#00BA38","#619CFF"))
```

`r include_fig("shrinkage.png",width="65%")`

`r vspace("-2em")`
.small[.alignright[`r icon::fontawesome("arrow-circle-left")` [Back](#shrinkage-slide)]]
---

# Effective number of parameters 

## Referred to as $p_D$

- Common Effect Model
   - $p_D =$ number of parameters

- Random Effects Model
   - $p_D$ depends on between-study standard deviation &ndash; it is a measure of **shrinkage** 
   - For sd close to 0, $\delta_i = d$; 1 parameter (as in common effect model &ndash; complete pooling)
   - For very large sd, $\delta_i = \delta_i$; parameter for each study (as in independent effects model &ndash; no pooling)
   
---

count: false

# Effective number of parameters 

## How many effective parameters in the magnesium example?

.pull-left[
### Fixed effects model (sd = 0): $[p_D=`r format(fixeff$pD,digits=2,nsmall=1)`]$     
$\alpha_i$, 16 studies     
$d$, common treatment effects

`r vspace("3.0em")`
### Random effects model (sd > 0) $[p_D=`r format(raneff$pD,digits=2,nsmall=1)`]$    
$\alpha_i$, 16 studies     
$\delta_i$, exchangeable (partial pooling)

`r vspace("3.0em")`
### Independent effects model (sd $\rightarrow \infty$) $[p_D=`r format(comeff$pD,digits=2,nsmall=1)`]$    
$\alpha_i$, 16 studies    
$\delta_i$, 16 independent treatment effects
]
.pull-right[
```{r,engine='tikz', echo=F, out.width="85%",opts=list(width="40%",title="INSERT TEXT HERE"),eval=FALSE}
\newcommand\blue{\color{blue}}

\begin{tikzpicture}
\draw(4,2) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](1){\textbf{\blue 17 parameters}};

\draw(4,-4) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](2){\textbf{\blue Up to 32 parameters}};

\draw(4.9,-1) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](3 ){};

\draw [<->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thick,blue] (1.south) -- (2.north);
\end{tikzpicture}
```

`r include_fig("nparams.png",width="38%")`

]

---

count: false

# Effective number of parameters 

<i class="fas fa-info-circle" style="color: #3162cc;"></i> The computation of $p_D$ is based on an **approximation**. 

- The original paper defining the DIC (`r icon::academicons$doi` [Spiegelhalter et al, 2002](https://rss.onlinelibrary.wiley.com/doi/10.1111/1467-9868.00353)) uses the definition
$$\class{myblue}{p_D=\overline{D(\bm\theta)}-D(\overline{\bm\theta})}$$

- That is not the only possible approximation. `r icon::fontawesome("book")` [Gelman et al (2004)](http://www.stat.columbia.edu/~gelman/book/) suggested
$$\class{myblue}{p_D=\frac{\Var\left[D(\bm\theta)\right]}{2}}$$
which is *invariant to parameterisations* of the model (and sometimes referred to as $p_V$ &ndash; see slide 7 of `r icon::fontawesome("firefox")` [this](https://www.mrc-bsu.cam.ac.uk/wp-content/uploads/DIC-slides.pdf))

--

- `R2OpenBUGS` takes advantage of the fact that `OpenBUGS` can compute both versions and gives the first one, by default

- `R2jags` (and `JAGS`) only use the second version

--

`r vspace("-10px")`
In the magnesium example, the two software give **completely** different answers
- In `R2jags` the distribution of $D(\bm\theta)$ is affected by a few *outliers* (simulations with **huge** values). This makes the estimate of its variance unstable and very large, thus generating ridiculous values for $p_D$
- Conversely, if you run the model with `R2OpenBUGS`, $p_D$ is computed using the first formula and returns sensible values


- See also `r icon::fontawesome("firefox")` [here](https://statmodeling.stat.columbia.edu/2006/07/06/number_of_param/) for a technical discussion of the implementation in `R2OpenBUGS`

---

# Prior for the between study SD

- Priors for between study sd, $\sigma$, are tricky!
   - Must be positive, but $\sigma = 0$ is feasible... most priors biased away from zero
  
 
- Typically limited data to estimate $\sigma$ 
   - Prior weight on high values can be problematic
   - Informative prior based on previous meta-analyses can be helpful (`r icon::academicons$pubmed` [Turner et al 2015](https://pubmed.ncbi.nlm.nih.gov/25475839/))
 
 
- Results can be sensitive to choice of prior
   - Uniform prior for $\sigma$ over a realistic range often a good choice
   - But check posterior not constrained by prior...
   - Consider sensitivity analysis

---

# Example

###  Prophylactic Neuraminidase Inhibitors (NIs) for Influenza

```{r,engine='tikz', echo=F, out.width="85%",opts=list(width="65%",title="INSERT TEXT HERE"),eval=FALSE}
\definecolor{myblue}{rgb}{0.14 0.34 0.55}
\begin{tikzpicture}
\draw(-6,1) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}
{8}\selectfont](1){Prophylactic NIs?};

\draw(-3,-1) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](2){No};

\draw(-3,3) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](3){Yes};

\draw(0,4) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](4){Yes \\$(p_1)$};

\draw(0,2) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](5){No \\$(1-p_1)$};

%\draw(3,4) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](6){Cost with NIs + cost influenza};
\draw(3,4) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](6){GP Cost + Cost of NI +\\ Cost and QALY loss of influenza};

\draw(3,2) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](7){GP Cost + Cost of NI};

\draw(0,0) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](8){Yes \\$(p_0)$};

\draw(0,-2) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](9){No \\$(1-p_0)$};

\draw(3,0) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](10){GP Cost + \\ Cost and QALY loss of influenza};

\draw(3,-2) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](11){GP cost};

\draw(3,4.8) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](12){\underline{Outcomes}};

\draw(0,4.8) node[align=center,draw=none,fill=none,minimum width=.5cm,minimum height=.5cm,font=\sffamily\fontsize{8}{9}\selectfont](12){\underline{Influenza?}};

\node [rectangle,minimum size=1.5mm,inner sep=0pt,outer sep=3pt,fill=black] at (-4.75,1) (dec1){};
\node [circle,minimum size=1.5mm,inner sep=0pt,outer sep=3pt,fill=black] at (-2.65,3) (rand2){};
\node [circle,minimum size=1.5mm,inner sep=0pt,outer sep=3pt,fill=black] at (-2.68,-1) (rand3){};

\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (1.east) |- (2.west);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (1.east) |- (3.west);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (3.east) |- (4.west);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (3.east) |- (5.west);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (2.east) |- (8.west);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (2.east) |- (9.west);
\end{tikzpicture}
```

`r include_fig("unnamed-chunk-11-1.png",width="65%")`

`r vspace("10px")`

- Absolute effect on reference (no NIs) informed by synthesis of H studies
- Relative effect for NI vs No NI informed by synthesis of RCTs

---

# Bayesian HTA in action

## Decision-analytic model (influenza)

.pull-left[

```{r,engine='tikz', echo=F, out.width="85%",opts=list(width="55%",title="INSERT TEXT HERE"),eval=FALSE}
\begin{tikzpicture}
\draw(-4,-4) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](1){$x_h$};
\draw(-5,-2.5) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](2){$\beta_h$};
\draw(-3,-2.5) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](3){$m_h$};
\draw(-5,-1) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](4){$\gamma_h$};
\draw(-6,.5) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](5){$\mu_\gamma$};
\draw(-4,.5) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](6){$\sigma^2_\gamma$};
\draw(-5,2) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](7){$p_0$};

\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (2.290) -- (1.130);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (3.250) -- (1.50);
\draw [dashed, ->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (4.south) -- (2.north);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (5.290) -- (4.130);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (6.250) -- (4.50);
\draw [dashed, ->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (5.50) -- (7.250);
\end{tikzpicture}
```

`r include_fig("dec-model-1.png",width="50%")`
]
.pull-right[
**Module 1**: Influenza incidence

- $H$ studies reporting number of patients who get influenza $(x_h)$ in the sample $(m_h)$

- $\beta_h=$ population probability of influenza from the $h-$th study:

  $\logit(\beta_h)=\gamma_h\sim\dnorm(\mu_\gamma,\sigma_\gamma)$

- $\class{red}{\mu_\gamma\sim\dnorm(0,v)}=$ pooled averaged probability of infection (on logit scale!)

  $\Rightarrow \class{red}{p_0=\displaystyle\frac{\exp(\mu_\gamma)}{1+\exp(\mu_\gamma)}}$
  
  (or equivalently $\class{red}{\logit(p_0)=\mu_\gamma}$)
]

---

count: false

# Bayesian HTA in action

## Decision-analytic model (influenza)

.pull-left[
**Module 2**: Prophylaxis effectiveness
- $S$ studies reporting number of infected patients $r^{(t)}_s$ in a sample made of $n^{(t)}_s$ subjects

- $\pi^{(t)}_s=$ study- and treatment-specific chance of contracting influenza

  $\logit\left(\pi^{(0)}_s\right) = \alpha_s \sim \dnorm(0, 10)$
  
  $\logit\left(\pi^{(1)}_s\right) = \alpha_s + \delta_s$
  
  $\delta_s \sim \dnorm(\mu_\delta,\sigma_\delta)=$ study-specific treatment effect
  
- $\class{blue}{\mu_\delta\sim\dnorm(0,v)}=$ pooled log-odds ratio of influenza given treatment
]
.pull-right[
```{r,engine='tikz', echo=F, out.width="85%",opts=list(width="85%",title="INSERT TEXT HERE"),eval=FALSE}
\begin{tikzpicture}
\draw(-1,-4) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](16){$r^{(0)}_s$};
\draw(-2,-2.5) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](17){$\pi^{(0)}_s$};
\draw(0,-2.5) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](18){$n^{(0)}_s$};
\draw(2,-4) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](19){$r^{(1)}_s$};
\draw(1,-2.5) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](20){$\pi^{(1)}_s$};
\draw(3,-2.5) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](21){$n^{(1)}_s$};
\draw(-1,-1) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](22){$\alpha_s$};
\draw(2,-1) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](23){$\delta_s$};
\draw(1,.5) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](24){$\mu_\delta$};
\draw(3,.5) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](25){$\sigma^2_\delta$};

\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (17.290) -- (16.130);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (18.250) -- (16.50);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (20.290) -- (19.130);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (21.250) -- (19.50);
\draw [dashed, ->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (22.240) -- (17.50);
\draw [dashed, ->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (22.310) -- (20.150);
\draw [dashed, ->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (23.240) -- (20.50);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (24.290) -- (23.130);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (25.250) -- (23.50);
\end{tikzpicture}
```

`r include_fig("dec-model-2.png",width="100%")`
]

---

count: false

# Bayesian HTA in action

## Decision-analytic model (influenza)
.alignright[
Can combine modules 1 and 2    
$\class{olive}{\logit(p_1)=\logit(p_0)+\mu_\delta}$
]

```{r,engine='tikz', echo=F, out.width="85%",opts=list(width="65%",title="INSERT TEXT HERE"),eval=FALSE}
\definecolor{olive}{rgb}{.2 .31 .09}
\newcommand\olive{\color{olive}}
\begin{tikzpicture}
\draw(-4,-4) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](1){$x_h$};
\draw(-5,-2.5) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](2){$\beta_h$};
\draw(-3,-2.5) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](3){$m_h$};
\draw(-5,-1) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](4){$\gamma_h$};
\draw(-6,.5) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](5){$\mu_\gamma$};
\draw(-4,.5) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](6){$\sigma^2_\gamma$};
\draw(-5,2) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](7){$p_0$};

\draw(-1,-4) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](16){$r^{(0)}_s$};
\draw(-2,-2.5) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](17){$\pi^{(0)}_s$};
\draw(0,-2.5) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](18){$n^{(0)}_s$};
\draw(2,-4) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](19){$r^{(1)}_s$};
\draw(1,-2.5) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](20){$\pi^{(1)}_s$};
\draw(3,-2.5) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](21){$n^{(1)}_s$};
\draw(-1,-1) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](22){$\alpha_s$};
\draw(2,-1) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](23){$\delta_s$};
\draw(1,.5) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](24){$\mu_\delta$};
\draw(3,.5) node[align=center,draw=none,font=\fontsize{7}{8}\selectfont](25){$\sigma^2_\delta$};

\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (2.290) -- (1.130);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (3.250) -- (1.50);
\draw [dashed, ->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (4.south) -- (2.north);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (5.290) -- (4.130);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (6.250) -- (4.50);
\draw [dashed, ->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (5.50) -- (7.250);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (17.290) -- (16.130);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (18.250) -- (16.50);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (20.290) -- (19.130);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (21.250) -- (19.50);
\draw [dashed, ->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (22.240) -- (17.50);
\draw [dashed, ->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (22.310) -- (20.150);
\draw [dashed, ->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (23.240) -- (20.50);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (24.290) -- (23.130);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (25.250) -- (23.50);
\end{tikzpicture}
```
`r include_fig("dec-model-3.png",width="65%")`

---

count: false

# Bayesian HTA in action

## Decision-analytic model (influenza)

`BUGS` code

```
model {
  # Evidence synthesis on incidence of influenza in the 
  # "healthy" adults population (t=0)
  for (h in 1:H) {
    x[h] ~ dbin(beta[h], m[h])
    logit(beta[h]) <- gamma[h]
    gamma[h] ~ dnorm(mu.gamma, tau.gamma)
  }
```
--
```
  # Evidence synthesis for effectiveness of NIs (t=1 vs t=0)
  for (s in 1:S) {
    r0[s] ~ dbin(pi0[s], n0[s])    
    r1[s] ~ dbin(pi1[s], n1[s])
    logit(pi0[s]) <- alpha[s]
    logit(pi1[s]) <- alpha[s]+delta[s]
    delta[s] ~ dnorm(mu.delta,tau.delta)
    alpha[s] ~ dnorm(0,0.00001)
  }
```

---

count: false

# Bayesian HTA in action

## Decision-analytic model (influenza)

`BUGS` code

```
  # Prior distributions
  mu.delta ~ dnorm(0,0.00001);       mu.gamma ~ dnorm(0,0.00001)
  sigma.delta ~ dunif(0,10);         tau.delta <- pow(sigma.delta,-2)
  sigma.gamma ~ dunif(0,10);         tau.gamma <- pow(sigma.gamma,-2)
  
  # Costs of influenza
  c.inf ~ dnorm(mu.inf,tau.inf)
      
  # Length of time to recovery when infected by influenza 
  l ~ dlnorm(mu.l,tau.l)

  # Odds Ratio of influenza under treatment with NIs 
  rho <- exp(mu.delta)

  # Estimated probability of influenza in "healthy adults" for t=0 
  logit(p0) <- mu.gamma

  # Estimated probability of influenza in "healthy adults" for t=1 
  logit(p1) <- mu.gamma + mu.delta
} 
```

---


count: false

# Bayesian HTA in action

```{r echo=FALSE,cache=TRUE,include=FALSE}
# Defines the data
# Number of interventions (t=0: control; t=1: prophylactic use of Neuramidase Inhibitors (NI) 
T <- 2 					

# Evidence synthesis on effectiveness of NIs prophylaxis vs placebo
r0 <- r1 <- n0 <- n1 <- numeric()	# defines observed cases & sample sizes
r0 <- c(34,40,9,19,6,34)
r1 <- c(11,7,3,3,3,4)
n0 <- c(554,423,144,268,251,462)
n1 <- c(553,414,144,268,252,493)
S <- length(r0)				# number of relevant studies

# Evidence synthesis on incidence of influenza in healthy adults (under t=0)
x <- m <- numeric()			# defines observed values for baseline risk
x <- c(0,6,5,6,25,18,14,3,27)
m <- c(23,241,159,137,519,298,137,24,132)
H <- length(x)

# Data on costs
unit.cost.drug <- 2.4		# unit (weekly) cost of NI
length.treat <- 6		# 6 weeks course of treatment
c.gp <- 19			# cost of GP visit to administer prophylactic NI
vat <- 1.175			# VAT
c.ni <- unit.cost.drug*length.treat*vat 

# Informative prior on cost of influenza 
mu.inf <- 16.78			# mean cost of influenza episode
sigma.inf <- 2.34		# sd cost of influenza episode
tau.inf <- 1/sigma.inf^2	# precision cost of influenza episode

# Informative prior on length of influenza episodes
## Compute the value of parameters (mulog,sigmalog) for a logNormal distribution to have mean and sd (m,s)
## Copyright Gianluca Baio 2012
lognPar <- function(m,s) {
  s2 <- s^2
  mulog <- log(m) - 0.5 * log(1+s2/m^2)
  s2log <- log(1+(s2/m^2))
  sigmalog <- sqrt(s2log)
  list(mulog = mulog, sigmalog = sigmalog)
}
m.l <- 8.2					# original value in the paper: 8.2
s.l <- sqrt(2)					# original value in the paper: sqrt(2)
mu.l <- lognPar(m.l,s.l)$mulog			# mean time to recovery (log scale)
sigma.l <- lognPar(m.l,s.l)$sigmalog		# sd time to recovery (log scale)
tau.l <- 1/sigma.l^2				# precision time to recovery (log scale)

# Parameters of unstructured effects
mean.alpha <- 0
sd.alpha <- sqrt(10)
prec.alpha <- 1/sd.alpha^2
mean.mu.delta <- 0
sd.mu.delta <- sqrt(10)
prec.mu.delta <- 1/sd.mu.delta^2
mean.mu.gamma <- 0
sd.mu.gamma <- 1000
prec.mu.gamma <- 1/sd.mu.gamma^2


# Prepares to launch JAGS
library(R2jags)

# Creates the data list
data <- list(S=S,H=H,r0=r0,r1=r1,n0=n0,n1=n1,x=x,m=m,mu.inf=mu.inf,tau.inf=tau.inf,
             mu.l=mu.l,tau.l=tau.l,mean.alpha=mean.alpha,prec.alpha=prec.alpha,
             mean.mu.delta=mean.mu.delta,prec.mu.delta=prec.mu.delta,
             mean.mu.gamma=mean.mu.gamma,prec.mu.gamma=prec.mu.gamma)

# Points to the txt file where the OpenBUGS model is saved
model.string="
model {  
# Evidence synthesis on incidence of influenza in 
# healthy adults in placebo group
	for(h in 1:H) {
  		x[h] ~ dbin(beta[h], m[h])
		logit(beta[h]) <- gamma[h]
		gamma[h] ~ dnorm(mu.gamma,tau.gamma)
	}

# Evidence synthesis for efffectiveness of NIs
	for (s in 1:S) { 
		r0[s] ~ dbin(pi0[s],n0[s])
		r1[s] ~ dbin(pi1[s],n1[s])
		logit(pi0[s]) <- alpha[s]
		logit(pi1[s]) <- alpha[s]+delta[s]
		delta[s] ~ dnorm(mu.delta,tau.delta)
		alpha[s] ~ dnorm(mean.alpha,prec.alpha)
	} 

# Prior distributions
	mu.delta ~ dnorm(mean.mu.delta,prec.mu.delta)       
	mu.gamma ~ dnorm(mean.mu.gamma,prec.mu.gamma)
	sigma.delta ~ dunif(0,10)
	tau.delta <- pow(sigma.delta,-2)
	sigma.gamma ~ dunif(0,10)
	tau.gamma <- pow(sigma.gamma,-2)
	phi ~ dnorm(0,0.0001)

# Costs of influenza
	c.inf ~ dnorm(mu.inf,tau.inf)
# Length of time to recovery when infected by influenza
	l ~ dlnorm(mu.l,tau.l)

# Odds Ratio of influenza under treatment with NIs
	rho <- exp(mu.delta)
# Estimated probability of influenza in healthy adults under t=0
	p1 <- exp(mu.gamma)/(1+exp(mu.gamma))	
# Estimated probability of influenza in healthy adults under t=1
	p2 <- (rho*p1/(1-p1))/(1+rho*p1/(1-p1))
} 
"
tmpf=tempfile()
tmps=file(tmpf,"w")
cat(model.string,file=tmps)


# Defines the parameters list
parameters <- c("p1","p2","l","c.inf","rho")

# Creates a function to draw random initial values 
inits <- function(){
  list(alpha=rnorm(S,0,1),delta=rnorm(S,0,1),mu.delta=rnorm(1),
       sigma.delta=runif(1),gamma=rnorm(H,0,1),mu.gamma=rnorm(1),
       sigma.gamma=runif(1),c.inf=rnorm(1))
}

# Sets the number of iterations, burnin and thinning
n.iter <- 10000
n.burnin <- 5000
n.thin <- 10

# Finally calls OpenBUGS to do the MCMC run and saves results to the object "es"
model <- jags(data=data,inits=inits,parameters.to.save=parameters,model.file=tmpf,
           n.chains=2, n.iter, n.burnin, n.thin, DIC=TRUE)

# Computes costs & benefits
attach.jags(model)
c <- e <- matrix(NA,n.sims,T)
c[,1] <- (1-p1)*(c.gp) + p1*(c.gp+c.inf)
c[,2] <- (1-p2)*(c.gp+c.ni) + p2*(c.gp+c.ni+c.inf)
e[,1] <- -l*p1
e[,2] <- -l*p2
```

```{css echo=FALSE}
.left-code {
  width: 32%;
  height: 92%;
  float: left;
}
.left-column h2, .left-column h3 {
  color: #035AA699;
}
.left-column h2:last-of-type, .left-column h3:last-child {
  color: #035AA6;
}
.right-code {
  width: 63%;
  float: right;
  padding-top: 0em;
}

```

.panelset[
.panel[
.panel-name[
Run model code
]
- See practical!
]
.panel[
.panel-name[Model fitting]
```{r echo=TRUE}
# ... Run the script to fit the evidence synthesis model, something like:
# model=jags(...)

# Then prints the output for selected parameters 
print(model,intervals=c(.025,.975),digits=3)
```
]
.panel[
.panel-name[Economic analysis]
```{r echo=TRUE}
# Combines output from MCMC model to define population average effectiveness & costs
attach.jags(model)
# Cost of treatment
c <- e <- matrix(NA,n.sims,T)
c[,1] <- (1-p1)*(c.gp) + p1*(c.gp+c.inf)
c[,2] <- (1-p2)*(c.gp+c.ni) + p2*(c.gp+c.ni+c.inf)

# Measure of effectiveness
e[,1] <- -l*p1
e[,2] <- -l*p2

# These are mu_e and mu_c and can be used to do the decision analysis!
```

- $l=$ proxy for QALY loss due to influenza (length of time to recovery)
- **NB**: GP cost incurred under all options, and so could be omitted from model...

]
.panel[
.panel-name[Correlations]
.pull-left[
```{r echo=FALSE,dev="tikz",fig.height=4,fig.width=4,opts=list(width="85%",title="INSERT TEXT HERE")}
plot(e,xlab="$\\mu_{e0}$",ylab="$\\mu_{e1}$",main="",axes=F,pch=20,cex=.6)
axis(1);axis(2)
```
]
.pull-right[
```{r echo=FALSE,dev="tikz",fig.height=4,fig.width=4,opts=list(width="85%",title="INSERT TEXT HERE")}
plot(c,xlab="$\\mu_{c0}$",ylab="$\\mu_{c1}$",main="",axes=F,pch=20,cex=.6)
axis(1);axis(2)
```

]
]
.panel[
.panel-name[Decision analysis]
.left-code[
```{r echo=TRUE,eval=FALSE}
library(BCEA)
trt.labels=c("status quo",
             "prophylaxis with NIs"
)
m <- bcea(e,c,ref=2,
          interventions=trt.labels,
          Kmax=10000
)
summary(m)
```
]
.right-code[
```{r echo=FALSE,eval=TRUE}
library(BCEA)
trt.labels=c("status quo","prophylaxis with NIs")
m <- bcea(e,c,ref=2,interventions=trt.labels,Kmax=10000)
summary(m)
```

`r vspace("-15px")`

.small[.alignright[`r icon::fontawesome("arrow-circle-right")` [Next lecture](../08_Missing/index.html)]]
]
]
]